# Malware Scanning - Quick Reference

Quick reference guide for implementing and using ClamAV malware scanning.

## Installation

```bash
# 1. Install npm package
npm install

# 2. Start ClamAV (Docker)
docker-compose -f docker-compose.clamav.yml up -d

# 3. Configure .env
ENABLE_MALWARE_SCAN=true
CLAMAV_HOST=localhost
CLAMAV_PORT=3310
```

## Usage in Routes

### Option 1: Using Upload Config (Recommended)

```javascript
const taskUpload = require('../configs/taskUpload');

app.post('/upload',
  authenticate,
  taskUpload.single('file'),
  taskUpload.malwareScan,  // Add this line
  controller.handleUpload
);
```

### Option 2: Direct Import

```javascript
const upload = require('../configs/multer');
const malwareScan = require('../middlewares/malwareScan.middleware');

app.post('/upload',
  authenticate,
  upload.single('file'),
  malwareScan,  // Add this line
  controller.handleUpload
);
```

### Option 3: Monitor Mode (Non-blocking)

```javascript
const { monitorOnly } = require('../middlewares/malwareScan.middleware');

app.post('/upload',
  authenticate,
  upload.single('file'),
  monitorOnly,  // Logs but doesn't block
  controller.handleUpload
);
```

## Programmatic Usage

```javascript
const malwareScanService = require('../services/malwareScan.service');

// Scan file by path
const result = await malwareScanService.scanFile('/path/to/file.pdf');
if (!result.clean) {
  console.error('Malware detected:', result.virus);
}

// Scan buffer
const buffer = fs.readFileSync('/path/to/file');
const result = await malwareScanService.scanBuffer(buffer, 'filename.pdf');

// Check health
const health = await malwareScanService.isHealthy();
console.log(health.healthy); // true/false

// Get status
const status = await malwareScanService.getStatus();
```

## Response Examples

### Clean File

Request proceeds normally to next middleware/controller.

### Infected File

```json
{
  "success": false,
  "error": true,
  "message": "ملف مرفوض: تم اكتشاف محتوى ضار",
  "code": "MALWARE_DETECTED",
  "details": {
    "fileName": "infected.exe",
    "virus": "Win.Trojan.Generic",
    "blocked": false
  }
}
```

### Scan Failed (Production)

```json
{
  "success": false,
  "error": true,
  "message": "فشل التحقق من سلامة الملف. يرجى المحاولة مرة أخرى.",
  "code": "SCAN_FAILED"
}
```

## Environment Behavior

| Scenario | Development | Production |
|----------|-------------|------------|
| Malware detected | Block & delete | Block & delete |
| ClamAV unavailable | Allow with warning | Block upload |
| Scan timeout | Allow with warning | Block upload |

## Health Check

```javascript
// In health service
const { checkMalwareScan } = require('../services/health.service');

const health = await checkMalwareScan();
console.log(health);

// Response:
{
  status: 'up',           // 'up', 'down', 'disabled'
  enabled: true,
  healthy: true,
  version: 'ClamAV 1.0.0',
  initialized: true,
  config: {
    host: 'localhost',
    port: '3310'
  }
}
```

## Testing

### Test with EICAR File

```bash
# Create EICAR test file
echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > eicar.txt

# Upload (should be blocked)
curl -X POST http://localhost:5000/api/tasks/123/attachments \
  -H "Authorization: Bearer TOKEN" \
  -F "file=@eicar.txt"
```

### Disable for Testing

```bash
# In .env
ENABLE_MALWARE_SCAN=false
```

## Docker Commands

```bash
# Start ClamAV
docker-compose -f docker-compose.clamav.yml up -d

# Check status
docker ps | grep clamav

# View logs
docker logs clamav

# Check health
docker exec clamav clamdscan --ping

# Update virus definitions
docker exec clamav freshclam

# Restart
docker restart clamav

# Stop
docker-compose -f docker-compose.clamav.yml down
```

## Troubleshooting

### ClamAV Not Connecting

```bash
# Check if running
docker ps | grep clamav

# Check logs
docker logs clamav

# Restart
docker restart clamav
```

### Slow Scanning

```bash
# Update definitions
docker exec clamav freshclam

# Check resource allocation in docker-compose.yml
# Increase memory/CPU if needed
```

## Current Integrations

- ✅ `/api/tasks/:id/attachments` - Task attachments
- ✅ `/api/tasks/:id/voice-memos` - Voice memos
- ✅ `/api/messages` - Message attachments

## File Structure

```
src/
├── services/
│   ├── malwareScan.service.js      # Core scanning logic
│   └── health.service.js           # Health check integration
├── middlewares/
│   └── malwareScan.middleware.js   # Express middleware
├── configs/
│   ├── taskUpload.js              # Exports malwareScan
│   └── multer.js                  # Exports malwareScan
└── routes/
    ├── task.route.js              # Uses malwareScan
    └── message.route.js           # Uses malwareScan

Dockerfile.clamav                   # ClamAV container
docker-compose.clamav.yml          # Docker Compose config
```

## Security Events

All events are logged to audit log:

```javascript
// Malware detected
{
  action: 'malware_detected',
  entityType: 'file_upload',
  severity: 'critical',
  status: 'blocked',
  details: {
    fileName: 'infected.exe',
    virus: 'Win.Trojan.Generic',
    userId: '...',
    ipAddress: '...'
  }
}

// Scan failed
{
  action: 'malware_scan_failed',
  entityType: 'file_upload',
  severity: 'high',
  status: 'warning',
  details: {
    errorMessage: 'Connection refused',
    environment: 'production'
  }
}
```

## Configuration Options

```bash
# Required
ENABLE_MALWARE_SCAN=true           # Enable/disable scanning
CLAMAV_HOST=localhost              # ClamAV hostname
CLAMAV_PORT=3310                   # ClamAV port

# Optional (in service code)
# - Scan timeout: 60 seconds (in NodeClam config)
# - Multi-threaded scanning: enabled
# - Auto-remove infected: disabled (manual control)
```

## Performance

| File Size | Scan Time |
|-----------|-----------|
| < 1 MB    | ~100-500ms |
| 1-10 MB   | ~500ms-2s |
| 10-50 MB  | ~2-10s |

## Common Issues

| Issue | Solution |
|-------|----------|
| Connection refused | Start ClamAV: `docker-compose up -d` |
| Slow scanning | Update definitions: `freshclam` |
| Out of memory | Increase Docker memory limit |
| False positives | Update ClamAV, whitelist file |

## Resources

- Full docs: `/docs/MALWARE_SCANNING.md`
- Setup guide: `/MALWARE_SCAN_SETUP.md`
- ClamAV: https://docs.clamav.net/
- Package: https://www.npmjs.com/package/clamscan

## Support Checklist

- [ ] ClamAV container running?
- [ ] Environment variables set?
- [ ] Health check passing?
- [ ] Virus definitions updated?
- [ ] Check audit logs for errors
- [ ] Review ClamAV logs
