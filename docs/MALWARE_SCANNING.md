# Malware Scanning with ClamAV

This document explains how to set up and use malware scanning for file uploads in the Traf3li backend.

## Overview

The malware scanning system provides automatic virus and malware detection for all file uploads using ClamAV (Clam AntiVirus). Files are scanned immediately after upload and before they are processed by the application.

## Features

- **Automatic Scanning**: All file uploads are automatically scanned for malware
- **Real-time Detection**: Scans happen immediately after upload, before file processing
- **Security Logging**: All malware detections and scan failures are logged to the audit log
- **Graceful Degradation**: Environment-aware behavior (dev vs production)
- **Multiple Scan Methods**: Supports file path scanning and buffer scanning
- **Health Monitoring**: Built-in health checks for ClamAV daemon
- **Monitor Mode**: Optional non-blocking scan mode for testing

## Architecture

### Components

1. **ClamAV Daemon** (`clamd`): Background service that performs virus scanning
2. **Malware Scan Service** (`/src/services/malwareScan.service.js`): Node.js service wrapper
3. **Malware Scan Middleware** (`/src/middlewares/malwareScan.middleware.js`): Express middleware
4. **Integration Points**: File upload configs and routes

### Flow

```
File Upload → Multer → Malware Scan Middleware → Controller
                                ↓
                         ClamAV Daemon
                                ↓
                    Clean: Proceed | Infected: Block & Delete
```

## Installation

### 1. Install Node.js Package

```bash
npm install clamscan
```

### 2. Install ClamAV Daemon

#### Docker (Recommended)

Use the provided Dockerfile to run ClamAV in a container:

```bash
# Build the ClamAV image
docker build -f Dockerfile.clamav -t traf3li-clamav .

# Run ClamAV daemon
docker run -d \
  --name clamav \
  -p 3310:3310 \
  --restart unless-stopped \
  traf3li-clamav
```

Or add to your `docker-compose.yml`:

```yaml
services:
  clamav:
    build:
      context: .
      dockerfile: Dockerfile.clamav
    container_name: traf3li-clamav
    ports:
      - "3310:3310"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "clamdscan", "--ping"]
      interval: 60s
      timeout: 10s
      start_period: 300s
      retries: 3
    networks:
      - traf3li-network

  backend:
    # ... your backend config
    environment:
      - ENABLE_MALWARE_SCAN=true
      - CLAMAV_HOST=clamav  # Use service name in Docker
      - CLAMAV_PORT=3310
    depends_on:
      - clamav
```

#### Linux (Ubuntu/Debian)

```bash
sudo apt-get update
sudo apt-get install clamav clamav-daemon

# Update virus database
sudo freshclam

# Start ClamAV daemon
sudo systemctl start clamav-daemon
sudo systemctl enable clamav-daemon
```

#### macOS

```bash
brew install clamav

# Update virus database
freshclam

# Configure and start daemon
cp /usr/local/etc/clamav/clamd.conf.sample /usr/local/etc/clamav/clamd.conf
# Edit clamd.conf to enable TCPSocket on port 3310
clamd
```

### 3. Configure Environment Variables

Add to your `.env` file:

```bash
# Enable malware scanning
ENABLE_MALWARE_SCAN=true

# ClamAV connection settings
CLAMAV_HOST=localhost  # Use "clamav" if running in Docker
CLAMAV_PORT=3310
```

## Usage

### In Routes

The malware scan middleware is automatically exported from the upload configs:

```javascript
const taskUpload = require('../configs/taskUpload');

// Single file upload with malware scanning
app.post('/upload',
  taskUpload.single('file'),
  taskUpload.malwareScan,  // Add malware scanning
  controller.handleUpload
);

// Multiple files upload with malware scanning
app.post('/upload-multiple',
  taskUpload.array('files', 10),
  taskUpload.malwareScan,  // Scans all files
  controller.handleMultipleUpload
);
```

### Monitor Mode (Non-blocking)

For testing or logging purposes, you can use monitor mode which logs detections but doesn't block uploads:

```javascript
const malwareScanMiddleware = require('../middlewares/malwareScan.middleware');

app.post('/upload',
  upload.single('file'),
  malwareScanMiddleware.monitorOnly,  // Log but don't block
  controller.handleUpload
);
```

### Programmatic Scanning

You can also use the malware scan service directly:

```javascript
const malwareScanService = require('../services/malwareScan.service');

// Scan a file by path
const result = await malwareScanService.scanFile('/path/to/file.pdf', {
  userId: req.userID,
  fileName: 'document.pdf'
});

if (!result.clean) {
  console.error('Malware detected:', result.virus);
}

// Scan a buffer
const buffer = fs.readFileSync('/path/to/file');
const result = await malwareScanService.scanBuffer(buffer, 'file.pdf', {
  userId: req.userID
});

// Check ClamAV health
const health = await malwareScanService.isHealthy();
console.log('ClamAV status:', health);
```

## Behavior

### Production Environment

- Malware scanning is **required**
- If scan fails (ClamAV unavailable), upload is **blocked**
- Infected files are **always blocked** and deleted
- All events are logged to audit log with **critical** severity

### Development Environment

- Malware scanning is **optional**
- If scan fails (ClamAV unavailable), upload is **allowed with warning**
- Infected files are **always blocked** and deleted
- Scan failures are logged with **high** severity

## Security Events

All security events are logged to the audit log:

### Malware Detected

```json
{
  "action": "malware_detected",
  "entityType": "file_upload",
  "severity": "critical",
  "status": "blocked",
  "details": {
    "fileName": "infected.exe",
    "fileSize": 1024000,
    "virus": "Win.Trojan.Generic",
    "userId": "user_id",
    "ipAddress": "192.168.1.1"
  }
}
```

### Scan Failed

```json
{
  "action": "malware_scan_failed",
  "entityType": "file_upload",
  "severity": "high",
  "status": "warning",
  "details": {
    "fileName": "document.pdf",
    "errorMessage": "Connection refused to ClamAV daemon",
    "environment": "production"
  }
}
```

## Health Monitoring

### Health Check Endpoint

Add a health check endpoint to monitor ClamAV status:

```javascript
const malwareScanService = require('../services/malwareScan.service');

app.get('/health/malware-scan', async (req, res) => {
  const status = await malwareScanService.getStatus();

  res.json({
    service: 'malware-scan',
    ...status
  });
});
```

### Example Response

```json
{
  "service": "malware-scan",
  "enabled": true,
  "initialized": true,
  "healthy": true,
  "version": "ClamAV 1.0.0",
  "environment": "production",
  "config": {
    "host": "localhost",
    "port": "3310"
  }
}
```

## Troubleshooting

### ClamAV Not Starting

**Symptom**: "Failed to initialize ClamAV: ECONNREFUSED"

**Solutions**:
1. Check if ClamAV daemon is running: `systemctl status clamav-daemon`
2. Verify port configuration: `netstat -an | grep 3310`
3. Check ClamAV logs: `tail -f /var/log/clamav/clamav.log`
4. Ensure firewall allows port 3310

### Slow Scanning

**Symptom**: File uploads are very slow

**Solutions**:
1. Update virus definitions: `freshclam`
2. Increase ClamAV memory: Edit `/etc/clamav/clamd.conf` and adjust `MaxThreads`
3. Consider hardware upgrade (ClamAV is CPU intensive)
4. For Docker: Allocate more resources to container

### False Positives

**Symptom**: Clean files are marked as infected

**Solutions**:
1. Update virus definitions: `freshclam`
2. Add file to whitelist in ClamAV config
3. Report false positive to ClamAV team

### Out of Memory

**Symptom**: ClamAV crashes with OOM errors

**Solutions**:
1. Increase container/system memory
2. Reduce `MaxScanSize` in clamd.conf
3. Limit file upload size in application

## Performance Considerations

### Scan Time

- Small files (<1MB): ~100-500ms
- Medium files (1-10MB): ~500ms-2s
- Large files (10-50MB): ~2-10s

### Resource Usage

- CPU: Moderate to high during scans
- Memory: ~500MB-1GB for ClamAV daemon
- Disk: ~200MB for virus definitions

### Optimization Tips

1. **Use TCP Socket**: Faster than local socket for containerized environments
2. **Multi-threading**: ClamAV supports multi-threaded scanning
3. **Keep Updated**: Latest ClamAV versions have performance improvements
4. **Async Processing**: Consider background job for very large files

## Integration Examples

### Current Integrations

- ✅ Task attachments (`/src/routes/task.route.js`)
- ✅ Voice memos (`/src/routes/task.route.js`)
- ✅ Message attachments (`/src/routes/message.route.js`)

### Adding to New Routes

```javascript
// Import upload config
const upload = require('../configs/multer');
// or
const taskUpload = require('../configs/taskUpload');

// Apply to route
app.post('/api/new-upload',
  authenticate,
  upload.single('file'),
  upload.malwareScan,  // Add this line
  controller.handleUpload
);
```

## Testing

### Test with EICAR Test File

The EICAR test file is a safe way to test malware detection:

```bash
# Create EICAR test file
echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > eicar.txt

# Try to upload it
curl -X POST http://localhost:5000/api/tasks/123/attachments \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@eicar.txt"
```

Expected response:

```json
{
  "success": false,
  "error": true,
  "message": "ملف مرفوض: تم اكتشاف محتوى ضار",
  "code": "MALWARE_DETECTED",
  "details": {
    "fileName": "eicar.txt",
    "virus": "EICAR-Test-File",
    "blocked": false
  }
}
```

### Disable for Testing

To temporarily disable scanning during development:

```bash
ENABLE_MALWARE_SCAN=false
```

## Security Best Practices

1. **Always Enable in Production**: Never disable malware scanning in production
2. **Regular Updates**: Keep ClamAV virus definitions updated (use freshclam)
3. **Monitor Logs**: Regularly review audit logs for malware detections
4. **Defense in Depth**: Combine with other security measures (file type validation, size limits)
5. **Incident Response**: Have a plan for handling malware detections
6. **Network Isolation**: Run ClamAV in isolated network segment if possible

## Maintenance

### Update Virus Definitions

ClamAV includes `freshclam` which updates virus definitions automatically. In Docker, this runs on container start and periodically.

For manual update:

```bash
# On host
sudo freshclam

# In Docker
docker exec clamav freshclam
```

### Monitor ClamAV Logs

```bash
# Docker
docker logs clamav

# Linux
tail -f /var/log/clamav/clamav.log
```

### Restart ClamAV

```bash
# Docker
docker restart clamav

# Linux
sudo systemctl restart clamav-daemon
```

## References

- [ClamAV Official Documentation](https://docs.clamav.net/)
- [ClamAV Docker Image](https://hub.docker.com/r/clamav/clamav)
- [node-clam Package](https://www.npmjs.com/package/clamscan)
- [EICAR Test File](https://www.eicar.org/download-anti-malware-testfile/)

## Support

For issues related to:
- **ClamAV installation**: See ClamAV documentation
- **Integration issues**: Check this documentation and audit logs
- **Performance**: Review Performance Considerations section
- **False positives**: Update definitions or contact ClamAV team
