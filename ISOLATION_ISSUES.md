# Firm Isolation Issues Report

Generated: 2025-12-28T07:06:04.506Z

## Models Missing lawyerId Field

These models have `firmId` but are missing `lawyerId` for solo lawyer support:

_None found_

## Controllers with Isolation Issues

These controllers build their own queries instead of using `req.firmQuery`:

### adminAudit.controller.js
- [ ] userId: adminUser._id || req.userId || req.userID,...
- [ ] Ternary without lawyerId: firmId ? { firmId: adminUser.firmId } : {}...
- [ ] Ternary without lawyerId: firmId ? { firmId: adminUser.firmId } : {}...
- [ ] Ternary without lawyerId: firmId ? { firmId: adminUser.firmId } : {}...
- [ ] Ternary without lawyerId: firmId ? { firmId: adminUser.firmId } : {}...
- [ ] Ternary without lawyerId: firmId ? { firmId: adminUser.firmId } : {}...

### adminCustomClaims.controller.js
- [ ] userId: adminUser._id || req.userId || req.userID,...

### adminDashboard.controller.js
- [ ] Ternary without lawyerId: firmId ? { firmId: adminUser.firmId } : {}...
- [ ] Ternary without lawyerId: firmId ? { firmId: adminUser.firmId } : {}...
- [ ] Ternary without lawyerId: firmId ? { firmId: adminUser.firmId } : {}...
- [ ] Ternary without lawyerId: firmId ? { firmId: adminUser.firmId } : {}...
- [ ] Ternary without lawyerId: firmId ? { firmId: adminUser.firmId } : {}...

### adminFirms.controller.js
- [ ] userId: adminUser._id || req.userId || req.userID,...

### adminUsers.controller.js
- [ ] userId: adminUser._id || req.userId || req.userID,...
- [ ] Ternary without lawyerId: firmId ? { firmId: adminUser.firmId } : {}...
- [ ] Ternary without lawyerId: firmId ? { firmId: adminUser.firmId } : {}...

### audit.controller.js
- [ ] userId: req.userID,...

### auth.controller.js
- [ ] userId: request.userID || request.userId...

### calendar.controller.js
- [ ] $or: [
                { assignedTo...
- [ ] $or: [
                { createdBy...

### case.controller.js
- [ ] userId: request.userID,...

### cloudStorage.controller.js
- [ ] userId: request.userID,...

### cspReport.controller.js
- [ ] userId: sanitizeForLog(req.userID),...

### discord.controller.js
- [ ] userId: request.userID,...

### event.controller.js
- [ ] $or: [
                { assignedTo...
- [ ] $or: [
                    { createdBy...
- [ ] Ternary without lawyerId: firmId
        ? { firmId }
        : {
            $or: [
 ...
- [ ] Ternary without lawyerId: firmId
        ? { firmId }
        : {
            $or: [
 ...

### fieldHistory.controller.js
- [ ] userId: req.userID,...

### gantt.controller.js
- [ ] $or: [
            { assignedTo...
- [ ] Ternary without lawyerId: firmId ? { firmId } : {}...
- [ ] Ternary without lawyerId: firmId ? { firmId } : {}...

### invoice.controller.js
- [ ] userId: req.userID,...

### message.controller.js
- [ ] userId: request.userID,...

### notification.controller.js
- [ ] userId: sanitizeObjectId(request.userID)...

### order.controller.js
- [ ] userId: gig.userID._id,...

### permission.controller.js
- [ ] userId: req.userID,...

### preparedReport.controller.js
- [ ] userId: req.userID...

### proposal.controller.js
- [ ] userId: job.userID._id,...

### question.controller.js
- [ ] userId: request.userID,...

### ssoConfig.controller.js
- [ ] userId: req.userID,...

### ssoRouting.controller.js
- [ ] userId: request.userID...

### staff.controller.js
- [ ] firmId
        ? { $or: [{ _id: id }, { staffId: i...

### stepUpAuth.controller.js
- [ ] userId: req.userID || req.userId...

### task.controller.js
- [ ] $or: [
                    { assignedTo...
- [ ] $or: [
            { createdBy...
- [ ] firmId
        ? { firmId: new mongoose.Types.Obje...
- [ ] const baseQuery = firmId
        ?...
- [ ] Ternary without lawyerId: firmId
        ? { firmId: new mongoose.Types.ObjectId(firmI...
- [ ] Ternary without lawyerId: firmId
        ? { firmId: new mongoose.Types.ObjectId(firmI...

### trades.controller.js
- [ ] Ternary without lawyerId: firmId ? { firmId } : { userId }...
- [ ] Ternary without lawyerId: firmId ? { firmId } : { userId }...
- [ ] Ternary without lawyerId: firmId ? { firmId } : { userId }...
- [ ] Ternary without lawyerId: firmId ? { firmId } : { userId }...
- [ ] Ternary without lawyerId: firmId ? { firmId } : { userId }...

### transaction.controller.js
- [ ] userId: req.userID }, { session });...


## Services with Isolation Issues

### adminTools.service.js
- [ ] $or: [{ assignedTo...

### permissionEnforcer.service.js
- [ ] userId: req.userID,...


## How to Fix

### Models
Add `lawyerId` field to each model:
```javascript
// For solo lawyers (no firm) - enables row-level security
lawyerId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    index: true
},
```

### Controllers
Replace custom query building with `req.firmQuery`:
```javascript
// BEFORE (bad)
const baseQuery = firmId
    ? { firmId: new mongoose.Types.ObjectId(firmId) }
    : { $or: [{ assignedTo: userId }, { createdBy: userId }] };

// AFTER (good)
const baseQuery = req.firmQuery; // Already set by firmFilter middleware
```
