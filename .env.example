# ==========================================
# TRAF3LI BACKEND ENVIRONMENT CONFIGURATION
# ==========================================
#
# üöÄ QUICK START GUIDE:
#   1. Copy this file: cp .env.example .env
#   2. Generate secrets (run each command 3 times, copy output):
#      node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
#   3. Paste the 3 generated values into JWT_SECRET, JWT_REFRESH_SECRET, and ENCRYPTION_KEY
#   4. Set MONGODB_URI to your MongoDB connection string
#   5. Configure optional services (Redis, Sentry, AWS S3, etc.) as needed
#   6. Start server: npm start
#
# ‚ö†Ô∏è  SECURITY WARNING:
#   - Never commit .env file to git (it's in .gitignore)
#   - Never share your secrets in Slack, email, or other channels
#   - Never reuse secrets across environments (dev, staging, production)
#   - Generate new secrets for each environment
#
# ==========================================
# ANONYMOUS/GUEST AUTHENTICATION (OPTIONAL)
# ==========================================
# Enable Supabase-style anonymous authentication
# When enabled, users can use the app without creating an account
# Anonymous users can later "upgrade" to full accounts
# SECURITY: Anonymous users have limited permissions and stricter rate limits
# Data cleanup: Anonymous user data is automatically deleted after 30 days of inactivity
ENABLE_ANONYMOUS_AUTH=false

# ==========================================
# SESSION MANAGEMENT CONFIGURATION
# ==========================================
# Comprehensive session management with security policies and anomaly detection.
# Features:
# - Concurrent session limits per user
# - Session inactivity timeout
# - Automatic session termination on password change
# - New session notifications
# - Device fingerprinting and tracking
# - Anomaly detection (IP changes, device changes)
# - Session statistics and monitoring

# Maximum number of concurrent active sessions per user
# Default: 5
# When this limit is exceeded, the oldest sessions are automatically terminated
# Set to 0 for unlimited sessions (not recommended for security)
MAX_CONCURRENT_SESSIONS=5

# Session inactivity timeout in seconds
# Default: 604800 (7 days)
# Sessions inactive for longer than this period will be automatically terminated
# Set to 0 to disable inactivity timeout (not recommended)
# Common values:
#   - 3600 (1 hour)
#   - 86400 (1 day)
#   - 604800 (7 days)
#   - 2592000 (30 days)
SESSION_INACTIVITY_TIMEOUT=604800

# Force logout all sessions on password change
# Default: true
# When enabled, all active sessions are terminated when user changes password
# This prevents attackers from maintaining access after password compromise
FORCE_LOGOUT_ON_PASSWORD_CHANGE=true

# Send notification on new session/device login
# Default: true
# When enabled, users receive an alert when they log in from a new device or location
# Notification includes device info, location, and session details
NOTIFY_NEW_SESSION=true

# Session anomaly detection
# Default: true
# Detects suspicious session activity such as:
#   - IP address changes mid-session
#   - User agent changes mid-session
#   - Impossible travel (login from different countries in short time)
# Suspicious sessions are flagged but not automatically terminated
ENABLE_SESSION_ANOMALY_DETECTION=true

# ==========================================
# CRITICAL SECURITY CONFIGURATION (REQUIRED)
# ==========================================
# These values MUST be set before starting the server.
# The application will fail to start if these are missing or invalid.

# JWT Secrets - Used for authentication tokens
# REQUIREMENTS:
#   - JWT_SECRET: Minimum 32 characters, used for access tokens (15 min expiry)
#   - JWT_REFRESH_SECRET: Minimum 32 characters, used for refresh tokens (7 day expiry)
#   - Must be different from each other
#   - Use cryptographically secure random values
#
# GENERATE NEW SECRETS (run these commands):
#   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
#   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
#
# Copy the output and paste below (one secret per line):
JWT_SECRET=your_secret_here
JWT_REFRESH_SECRET=your_secret_here

# ==========================================
# JWT KEY ROTATION (OPTIONAL - ADVANCED SECURITY)
# ==========================================
# Enable automatic JWT signing key rotation for enhanced security.
# When enabled, the system will:
#   - Use multiple signing keys (current + previous)
#   - Add 'kid' (Key ID) to JWT headers for key versioning
#   - Automatically rotate keys at specified intervals
#   - Keep old keys active during grace period for seamless transitions
#
# BENEFITS:
#   - Limits impact of key compromise (keys are rotated regularly)
#   - Enables zero-downtime key updates
#   - Supports multiple active keys simultaneously
#
# REQUIREMENTS:
#   - Redis recommended for production (auto-persistence)
#   - Manual .env updates if using 'env' storage method
#
# CONFIGURATION:
ENABLE_JWT_KEY_ROTATION=false

# How often to rotate keys (in days)
# Default: 30 days
# Recommended: 30-90 days for production
JWT_KEY_ROTATION_INTERVAL=30

# How long to keep old keys valid after rotation (in days)
# Default: 7 days
# This grace period allows tokens signed with old keys to remain valid
# Recommended: 7-14 days (should be longer than max token lifetime)
JWT_KEY_ROTATION_GRACE_PERIOD=7

# Storage method for JWT signing keys
# Options:
#   - env: Store in JWT_SIGNING_KEYS environment variable (manual updates required)
#   - redis: Store in Redis (automatic persistence, recommended for production)
# Default: env
JWT_KEYS_STORAGE=redis

# JWT Signing Keys (JSON array)
# Only used when JWT_KEYS_STORAGE=env
# This is automatically managed by the key rotation service
# Format: [{"kid":"krot_123","secret":"...","algorithm":"HS256","status":"active","createdAt":"..."}]
# Leave empty on first startup - the system will generate initial keys
JWT_SIGNING_KEYS=

# Encryption Key - Used for encrypting sensitive data at rest
# REQUIREMENTS:
#   - Must be exactly 64 hexadecimal characters (32 bytes)
#   - Used for AES-256-GCM encryption of sensitive legal/financial data
#   - Never change this after encrypting data (you won't be able to decrypt)
#
# GENERATE NEW KEY (run this command):
#   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
#
# Copy the output and paste below:
ENCRYPTION_KEY=your_key_here

# DO NOT CHANGE - Encryption algorithm (AES-256-GCM is the standard)
ENCRYPTION_ALGORITHM=aes-256-gcm

# Database Connection
# REQUIREMENTS:
#   - Must be a valid MongoDB connection string
#   - Format: mongodb://[user]:[password]@[host]:[port]/[database]
#   - For MongoDB Atlas: mongodb+srv://[user]:[password]@[cluster]/[database]
#   - Production: Should use SSL/TLS (?ssl=true or ?tls=true)
#
# EXAMPLE:
#   Local: mongodb://localhost:27017/traf3li
#   Atlas: mongodb+srv://user:password@cluster.mongodb.net/traf3li?retryWrites=true&w=majority
MONGODB_URI=your_mongodb_uri

# Server
PORT=5000
NODE_ENV=production

# Security
ADMIN_IP_WHITELIST=your.ip.here

# ==========================================
# CSRF PROTECTION (CROSS-SITE REQUEST FORGERY)
# ==========================================
# Enable CSRF token protection for state-changing requests.
# When enabled, the system will:
#   - Generate cryptographically secure tokens using crypto.randomBytes
#   - Store tokens in Redis with configurable TTL
#   - Validate X-CSRF-Token header on POST/PUT/DELETE/PATCH requests
#   - Support double-submit cookie pattern as fallback
#   - Automatically rotate tokens after validation
#
# BENEFITS:
#   - Prevents CSRF attacks on authentication endpoints
#   - Protects state-changing operations (logout, password change, MFA)
#   - Works alongside SameSite cookies for defense in depth
#   - Production-ready with graceful degradation
#
# SECURITY:
#   - Tokens are 32 bytes (64 hex characters) for cryptographic strength
#   - Session-based validation prevents token reuse
#   - Automatic expiration with configurable TTL
#   - Rotation after each use prevents replay attacks
#
# USAGE:
#   - Login: Returns CSRF token in response body + cookie
#   - State-changing requests: Include token in X-CSRF-Token header
#   - Token refresh: GET /api/auth/csrf for fresh token
#
# Set to "true" to enable, "false" to disable (opt-in for backwards compatibility)
ENABLE_CSRF_PROTECTION=false

# CSRF token time-to-live in seconds
# Default: 3600 (1 hour)
# Recommended: 1800-7200 (30 minutes to 2 hours)
CSRF_TOKEN_TTL=3600

# ==========================================
# PASSWORD BREACH DETECTION (HAVEIBEENPWNED)
# ==========================================
# Enable password breach checking using HaveIBeenPwned API.
# When enabled, the system will:
#   - Check passwords against 800+ million leaked passwords
#   - Use k-anonymity model (never sends full password hash)
#   - Only send first 5 characters of SHA1 hash to API
#   - Cache results for 1 hour to reduce API calls
#   - Gracefully degrade if API is unavailable (allows password)
#
# BENEFITS:
#   - Prevents users from using passwords leaked in data breaches
#   - Meets Supabase Auth Pro tier security standards
#   - Zero privacy risk (k-anonymity model)
#   - Production-ready with caching and error handling
#
# PERFORMANCE:
#   - API response time: ~200-500ms (first check)
#   - Cached response time: <10ms (subsequent checks)
#   - Multi-level cache (in-memory + Redis)
#   - Rate limiting via caching
#
# PRIVACY & SECURITY:
#   - Full password never leaves your server
#   - Only first 5 chars of SHA1 hash sent to API
#   - API returns ~500 matching hashes
#   - Local comparison determines if password is breached
#   - More info: https://haveibeenpwned.com/API/v3#PwnedPasswords
#
# USAGE:
#   - Registration: Rejects breached passwords
#   - Password change: Rejects breached passwords
#   - Password reset: Rejects breached passwords
#
# Set to "true" to enable, "false" to disable
ENABLE_PASSWORD_BREACH_CHECK=true

# Frontend URLs
CLIENT_URL=https://traf3li.com
DASHBOARD_URL=https://dashboard.traf3li.com

# Backend URL (for SAML/SSO metadata and callbacks)
BACKEND_URL=https://api.traf3li.com

# Stripe
STRIPE_SECRET_KEY=your_stripe_key

# Cloudinary
CLOUDINARY_CLOUD_NAME=your_name
CLOUDINARY_API_KEY=your_key
CLOUDINARY_API_SECRET=your_secret

# AWS S3 (for file storage)
AWS_ACCESS_KEY_ID=your_access_key_id
AWS_SECRET_ACCESS_KEY=your_secret_access_key
AWS_REGION=me-south-1

# S3 Buckets - Use either naming convention:
# Option 1 (recommended): S3_BUCKET_* prefix
S3_BUCKET_DOCUMENTS=traf3li-legal-documents
S3_BUCKET_JUDGMENTS=traf3li-case-judgments
S3_BUCKET_TASKS=traf3li-task-attachments

# Option 2 (alternative): AWS_S3_* prefix
# AWS_S3_BUCKET=traf3li-legal-documents
# AWS_S3_BUCKET_DOCUMENTS=traf3li-legal-documents
# AWS_S3_JUDGMENTS_BUCKET=traf3li-case-judgments

# S3 Logging Buckets (optional - for access tracking)
# Enable versioning on main buckets for version history support
S3_BUCKET_DOCUMENTS_LOGS=traf3li-documents-logs
S3_BUCKET_TASKS_LOGS=traf3li-tasks-logs
# Alternative naming:
# AWS_S3_BUCKET_DOCUMENTS_LOGS=traf3li-documents-logs
# AWS_S3_BUCKET_TASKS_LOGS=traf3li-tasks-logs

# S3 Server-Side Encryption (SSE)
# SSE is enabled by default using AES256 (SSE-S3)
S3_SSE_ENABLED=true
S3_SSE_ALGORITHM=AES256
# For SSE-KMS encryption with Bucket Key (reduces KMS costs):
# S3_SSE_ALGORITHM=aws:kms
# S3_KMS_KEY_ID=arn:aws:kms:region:account:key/key-id
# S3_BUCKET_KEY_ENABLED=true

# Presigned URL expiry time in seconds (default: 3600 = 1 hour)
PRESIGNED_URL_EXPIRY=3600

# ==========================================
# REDIS CONFIGURATION (RECOMMENDED)
# ==========================================
# Redis is used for caching, rate limiting, session storage, and job queues.
# While not strictly required, it's highly recommended for production.
#
# SETUP (Local Development):
#   1. Install Redis: brew install redis (macOS) or apt-get install redis (Linux)
#   2. Start Redis: redis-server
#   3. Use: redis://localhost:6379
#
# SETUP (Production):
#   - Upstash (Free tier): https://upstash.com
#   - Redis Labs: https://redis.com
#   - AWS ElastiCache: https://aws.amazon.com/elasticache/
#
# NOTE: If not set, the application will use in-memory fallbacks (not shared across instances)

# Redis connection URL
# Format: redis://[username]:[password]@[host]:[port]/[database]
# Examples:
#   Local: redis://localhost:6379
#   Docker: redis://redis:6379
#   Upstash: redis://default:[password]@[endpoint].upstash.io:6379
#   Cloud: redis://:password@redis.example.com:6379
REDIS_URL=redis://localhost:6379

# Redis password (leave empty for local development without auth)
REDIS_PASSWORD=

# ‚ö†Ô∏è  REDIS OPTIMIZATION FOR FREE TIER (Upstash 500k requests/month)
# Set these to reduce Redis usage if you're hitting limits:

# Disable Bull job queues entirely (email, PDF, reports run synchronously)
# Set to "true" to save ~70k requests/month from queue polling
DISABLE_QUEUES=false

# Disable Redis caching, use in-memory cache instead
# Set to "true" to eliminate cache-related Redis calls
# Note: In-memory cache is per-process, not shared across instances
DISABLE_REDIS_CACHE=false

# Redis use cases in this application:
# - Idempotency keys for preventing duplicate transactions
# - Response caching for high-traffic endpoints (dashboard, clients, cases)
# - Session storage
# - Rate limiting counters
# - Job queues (email, PDF, reports, cleanup, sync, notifications)

# ==========================================
# ACCOUNTING SYSTEM CONFIGURATION
# ==========================================

# Currency Settings
DEFAULT_CURRENCY=SAR

# Default Account IDs (set after running seed:accounts)
# These are populated by the seeder, but can be overridden
# ACCOUNTS_RECEIVABLE_ID=
# ACCOUNTS_PAYABLE_ID=
# SERVICE_REVENUE_ID=
# BANK_ACCOUNT_MAIN_ID=

# Accounting Features
ENABLE_ACCOUNTING=true
REQUIRE_IDEMPOTENCY_KEYS=true

# ==========================================
# SMS PROVIDERS (for Phone OTP Authentication)
# ==========================================
# Configure at least one SMS provider for phone OTP authentication.
# Twilio is the primary provider, MSG91 is used as fallback.
#
# SETUP (Twilio - Recommended):
#   1. Create account at https://www.twilio.com/try-twilio
#   2. Get your Account SID and Auth Token from Console Dashboard
#   3. Purchase a phone number with SMS capabilities
#   4. Add credentials below
#
# SETUP (MSG91 - Fallback/Alternative):
#   1. Create account at https://msg91.com
#   2. Get your Auth Key from Settings
#   3. Configure Sender ID and Route
#   4. Add credentials below
#
# NOTE: If neither is configured, phone OTP endpoints will return an error

# Twilio Configuration (Primary SMS Provider)
TWILIO_ACCOUNT_SID=
TWILIO_AUTH_TOKEN=
TWILIO_PHONE_NUMBER=

# MSG91 Configuration (Fallback SMS Provider)
# MSG91_AUTH_KEY=
# MSG91_SENDER_ID=TRAF3L
# MSG91_ROUTE=transactional

# ==========================================
# CAPTCHA VERIFICATION (Bot Protection)
# ==========================================
# Configure CAPTCHA providers for bot protection on sensitive endpoints.
# Supports multiple providers: reCAPTCHA, hCaptcha, and Cloudflare Turnstile.
#
# SETUP (Google reCAPTCHA - Recommended):
#   1. Create account at https://www.google.com/recaptcha/admin
#   2. Choose reCAPTCHA v2 (checkbox) or v3 (score-based)
#   3. Add your domain(s) (e.g., traf3li.com, dashboard.traf3li.com)
#   4. Copy Site Key (for frontend) and Secret Key (below)
#
# SETUP (hCaptcha - Alternative):
#   1. Create account at https://www.hcaptcha.com
#   2. Create new site
#   3. Copy Site Key (for frontend) and Secret Key (below)
#
# SETUP (Cloudflare Turnstile - Managed Challenge):
#   1. Create account at https://dash.cloudflare.com
#   2. Go to Turnstile tab
#   3. Create new site
#   4. Copy Site Key (for frontend) and Secret Key (below)
#
# NOTE: Only the secret keys are needed in backend. Site keys go in frontend env.

# Google reCAPTCHA Configuration
# Get keys from: https://www.google.com/recaptcha/admin
RECAPTCHA_SECRET_KEY=

# reCAPTCHA v3 minimum score (0.0 to 1.0, where 1.0 = very likely human)
# Default: 0.5 (recommended for most cases)
# Higher values = stricter (may block legitimate users)
# Lower values = more lenient (may allow more bots)
RECAPTCHA_MIN_SCORE=0.5

# hCaptcha Configuration
# Get keys from: https://dashboard.hcaptcha.com
HCAPTCHA_SECRET_KEY=

# Cloudflare Turnstile Configuration
# Get keys from: https://dash.cloudflare.com/turnstile
TURNSTILE_SECRET_KEY=

# CAPTCHA Enforcement Settings
# Control when CAPTCHA verification is required

# Require CAPTCHA on user registration
# Options: true, false
# Default: true (recommended to prevent spam registrations)
CAPTCHA_REQUIRED_ON_REGISTER=true

# Require CAPTCHA on user login
# Options:
#   - true: Always require CAPTCHA on login
#   - false: Never require CAPTCHA on login
#   - after_failures: Only require after failed login attempts (recommended)
# Default: after_failures
CAPTCHA_REQUIRED_ON_LOGIN=after_failures

# Number of failed login attempts before requiring CAPTCHA
# Only used when CAPTCHA_REQUIRED_ON_LOGIN=after_failures
# Default: 3
CAPTCHA_FAILED_LOGIN_THRESHOLD=3

# Require CAPTCHA on password reset requests
# Options: true, false
# Default: true (recommended to prevent email enumeration and spam)
CAPTCHA_REQUIRED_ON_FORGOT_PASSWORD=true

# Default CAPTCHA provider (used if frontend doesn't specify)
# Options: recaptcha, hcaptcha, turnstile
# Default: recaptcha
CAPTCHA_DEFAULT_PROVIDER=recaptcha

# ==========================================
# LOGGING CONFIGURATION
# ==========================================

# Log level: error, warn, info, debug
LOG_LEVEL=info

# ==========================================
# ANALYTICS CONFIGURATION
# ==========================================

# Analytics event tracking (matches frontend taxonomy)
# Events tracked: page_view, search, form_submit, error, api_call, user_action
# Set to false to disable analytics tracking
ENABLE_ANALYTICS=true

# Analytics buffer settings
# Events are batched and flushed periodically to reduce overhead
ANALYTICS_BUFFER_FLUSH_INTERVAL=30000
ANALYTICS_MAX_BUFFER_SIZE=100

# External analytics integrations (optional)
# Google Analytics Measurement Protocol
# GA_MEASUREMENT_ID=G-XXXXXXXXXX
# GA_API_SECRET=your_api_secret

# Mixpanel
# MIXPANEL_TOKEN=your_mixpanel_token

# Segment
# SEGMENT_WRITE_KEY=your_segment_write_key

# ==========================================
# PERFORMANCE MONITORING
# ==========================================

# API response time target (in ms)
# Frontend expects backend APIs to respond within this threshold
API_RESPONSE_TIME_TARGET=300

# Performance thresholds (in ms)
# PERF_THRESHOLD_EXCELLENT=100
# PERF_THRESHOLD_GOOD=300
# PERF_THRESHOLD_ACCEPTABLE=1000
# PERF_THRESHOLD_SLOW=3000

# Performance monitoring endpoints
# GET /metrics/performance - Detailed API performance metrics
# Includes: avg response time, percentiles (p50, p90, p99), slowest endpoints

# ==========================================
# SENTRY ERROR TRACKING (RECOMMENDED)
# ==========================================
# Sentry provides real-time error tracking and performance monitoring.
# While not required, it's highly recommended for production environments.
#
# SETUP:
#   1. Create account at https://sentry.io
#   2. Create a new Node.js project
#   3. Copy the DSN from Project Settings > Client Keys (DSN)
#   4. Paste it below
#
# NOTE: If not set, error tracking will be disabled (not recommended for production)

# Sentry DSN (Data Source Name) - Get this from your Sentry project settings
# Format: https://[key]@[organization].ingest.sentry.io/[project-id]
SENTRY_DSN=https://your-sentry-dsn@sentry.io/your-project-id

# Sentry environment (production, staging, development)
SENTRY_ENVIRONMENT=production

# Sentry traces sample rate (0.0 to 1.0, where 1.0 = 100%)
# Lower values reduce performance monitoring overhead
SENTRY_TRACES_SAMPLE_RATE=0.1

# Sentry profiles sample rate (0.0 to 1.0, where 1.0 = 100%)
# Only needed if using profiling
SENTRY_PROFILES_SAMPLE_RATE=0.1

# ==========================================
# WHATSAPP / META CONFIGURATION
# ==========================================

# Meta WhatsApp Business API
# WHATSAPP_PHONE_NUMBER_ID=
# WHATSAPP_ACCESS_TOKEN=
# WHATSAPP_VERIFY_TOKEN=
# WHATSAPP_BUSINESS_ACCOUNT_ID=

# Webhook Secret for WhatsApp/Meta webhooks (HMAC-SHA256 signature validation)
# Get this from Meta App Dashboard > WhatsApp > Configuration > Webhook
# Used to validate webhook signatures via x-hub-signature-256 header
# WHATSAPP_WEBHOOK_SECRET=your_app_secret_here

# ==========================================
# EMAIL CONFIGURATION
# ==========================================

# Resend API for email sending
RESEND_API_KEY=your_resend_api_key

# Email sender configuration
EMAIL_FROM=noreply@traf3li.com
EMAIL_FROM_NAME=Traf3li
EMAIL_REPLY_TO=support@traf3li.com

# Email branding
LOGO_URL=https://traf3li.com/logo.png

# Email templates support both Arabic and English
# Templates include: welcome, otp, invoice, payment-receipt, case-update, reminder, password-reset
# Layouts: base (full featured), notification (simple), transactional (invoices/receipts)

# ==========================================
# SAUDI BANKING INTEGRATION
# ==========================================

# Lean Technologies (Open Banking)
# LEAN_APP_TOKEN=
# LEAN_CUSTOMER_ID=

# SADAD Integration
# SADAD_MERCHANT_ID=
# SADAD_API_KEY=

# ZATCA (VAT Invoicing)
# ZATCA_API_KEY=
# ZATCA_ORGANIZATION_ID=

# ==========================================
# MICROSOFT 365 CALENDAR INTEGRATION
# ==========================================
# Microsoft Graph API configuration for calendar sync
# Get credentials from Azure Portal: https://portal.azure.com
# App Registration -> New Registration -> API Permissions -> Microsoft Graph

# OAuth Application Credentials
# MICROSOFT_CLIENT_ID=your_client_id_here
# MICROSOFT_CLIENT_SECRET=your_client_secret_here

# OAuth Redirect URI (must match Azure configuration)
# MICROSOFT_REDIRECT_URI=http://localhost:3000/api/microsoft-calendar/callback
# Production: https://api.traf3li.com/api/microsoft-calendar/callback

# Required Microsoft Graph API Scopes:
# - offline_access (refresh tokens)
# - User.Read (user profile)
# - Calendars.ReadWrite (calendar access)
# - Calendars.ReadWrite.Shared (shared calendars)

# ==========================================
# BACKUP CONFIGURATION
# ==========================================

# S3 Backup Bucket
BACKUP_S3_BUCKET=traf3li-backups

# Retention Policies (in days/weeks/months)
BACKUP_RETENTION_DAYS=7
BACKUP_RETENTION_WEEKS=4
BACKUP_RETENTION_MONTHS=12
BACKUP_RETENTION_YEARS=3

# Backup Schedules (cron expressions)
# Daily at 2 AM
BACKUP_SCHEDULE_DAILY=0 2 * * *
# Weekly on Sunday at 3 AM
BACKUP_SCHEDULE_WEEKLY=0 3 * * 0
# Monthly on the 1st at 4 AM
BACKUP_SCHEDULE_MONTHLY=0 4 1 * *
# Redis every 6 hours
BACKUP_SCHEDULE_REDIS=0 */6 * * *

# Notification Settings
BACKUP_NOTIFICATION_ENABLED=true
BACKUP_NOTIFICATION_EMAIL=admin@traf3li.com
BACKUP_NOTIFY_ON_SUCCESS=false

# Backup Settings
BACKUP_TEMP_DIR=/tmp/backups
BACKUP_MAX_FILE_SIZE=524288000
BACKUP_COMPRESSION_LEVEL=6

# Point-in-Time Recovery (PITR)
BACKUP_ENABLE_PITR=false
BACKUP_PITR_INTERVAL=15

# Redis Settings (if different from main Redis)
REDIS_DATA_DIR=/data

# Restore Settings
RESTORE_TEMP_DIR=/tmp/restore
RESTORE_BACKUP_BEFORE=true

# ==========================================
# MALWARE SCANNING (ClamAV)
# ==========================================

# Enable malware scanning for file uploads
# Set to "true" to enable ClamAV scanning, "false" to disable
ENABLE_MALWARE_SCAN=true

# ClamAV daemon connection settings
# For Docker: use service name (e.g., "clamav")
# For local: use "localhost"
CLAMAV_HOST=localhost

# ClamAV daemon TCP port
# Default ClamAV TCP socket port is 3310
CLAMAV_PORT=3310

# Malware scanning behavior:
# - Development: Scan if available, allow upload if scan fails (with warning)
# - Production: Scan required, block upload if scan fails
# Note: Infected files are ALWAYS blocked in both environments

# ==========================================
# GEOGRAPHIC ANOMALY DETECTION (AUTHENTICATION SECURITY)
# ==========================================
# Enable geographic anomaly detection for authentication.
# Detects suspicious logins based on location changes and travel patterns.
#
# FEATURES:
# - Impossible travel detection (login from different country too quickly)
# - First login from new country detection
# - VPN/Proxy IP detection
# - Unusual login time detection
# - Configurable response actions
#
# HOW IT WORKS:
# - When user logs in, system checks their IP location
# - Compares with previous login locations and timestamps
# - Calculates travel speed between locations
# - Flags as anomalous if speed exceeds physical possibility (e.g., 500 km/h)
# - Creates security incidents for review
# - Can block, require verification, notify, or just log
#
# GEOLOCATION:
# - Uses IP-API.com for free IP geolocation (45 requests/min)
# - Caches results for 1 hour to reduce API calls
# - Falls back gracefully if service is unavailable
#
# PERFORMANCE:
# - Runs asynchronously (fire-and-forget) to not block login
# - Uses cached geoip lookups to minimize latency
# - Auto-cleanup of old login history (90 days)

# Enable/disable geographic anomaly detection
# Set to "false" to disable, "true" to enable
# Default: true
ENABLE_GEO_ANOMALY_DETECTION=true

# Maximum travel speed threshold (in km/h)
# Logins that require travel speed above this are flagged as impossible travel
# Default: 500 km/h (typical commercial aircraft speed)
# Examples:
#   - 500 km/h: Normal setting (catches impossible travel)
#   - 1000 km/h: Lenient setting (only catches extreme cases)
#   - 300 km/h: Strict setting (may flag high-speed rail travel)
MAX_TRAVEL_SPEED_KMH=500

# Action to take when anomaly is detected
# Options:
#   - block: Block the login and require admin review
#   - verify: Allow login but require additional verification (MFA or email)
#   - notify: Allow login and send notification to user
#   - log: Allow login and just log the incident for monitoring
# Default: verify
# Recommended for production: verify
ANOMALY_ACTION=verify

# ==========================================
# SAML/SSO CONFIGURATION (Enterprise)
# ==========================================

# SAML is configured per firm through the admin dashboard
# Each firm can have its own IdP configuration (Azure AD, Okta, Google Workspace, etc.)

# SAML endpoints are automatically generated using BACKEND_URL:
# - SP Entity ID: {BACKEND_URL}/api/auth/saml/{firmId}
# - ACS URL: {BACKEND_URL}/api/auth/saml/acs/{firmId}
# - SLS URL: {BACKEND_URL}/api/auth/saml/sls/{firmId}
# - Metadata URL: {BACKEND_URL}/api/auth/saml/metadata/{firmId}

# Configuration is done through the dashboard:
# Dashboard -> Settings -> Enterprise -> SSO Configuration

# Required information from IdP:
# - Provider Type (azure, okta, google, custom)
# - Entity ID / Issuer URL
# - SSO URL / Sign-in URL
# - X.509 Certificate (PEM format)
# - Metadata URL (optional)

# Supported Providers:
# - Microsoft Azure AD (Entra ID)
# - Okta
# - Google Workspace
# - Any SAML 2.0 compliant IdP

# Features:
# - Just-in-Time (JIT) user provisioning
# - Attribute mapping (email, firstName, lastName, groups)
# - Single Logout (SLO) support
# - Multi-tenancy (firm-level isolation)
# - Automatic JWT token generation after SSO

# ==========================================
# APPLE SIGN-IN (OAUTH)
# ==========================================
# Apple Sign-In (Sign in with Apple) for OAuth authentication
# Get credentials from: https://developer.apple.com/account/resources/identifiers/list
#
# Setup Instructions:
# 1. Create an App ID in Apple Developer Portal
# 2. Enable "Sign in with Apple" capability
# 3. Create a Services ID (this will be your APPLE_CLIENT_ID)
# 4. Create a Key for Sign in with Apple (download the .p8 file)
# 5. Note your Team ID from the top right of developer portal
#
# Required Scopes: name, email
# OAuth Redirect URL: {BACKEND_URL}/api/auth/sso/apple/callback
#
# IMPORTANT NOTES:
# - Apple uses JWT-based client secrets (not regular secrets)
# - Client secret must be generated from your private key
# - User info comes from id_token JWT, not a userinfo endpoint
# - Email may be a relay email (privaterelay.appleid.com)
# - Name is only provided on first authorization
# - response_mode must be 'form_post'

# Apple Services ID (your OAuth Client ID)
# APPLE_CLIENT_ID=com.traf3li.services

# Apple Team ID (10-character team identifier)
# APPLE_TEAM_ID=ABC1234DEF

# Apple Key ID (10-character key identifier from the .p8 key file)
# APPLE_KEY_ID=XYZ9876WVU

# Apple Private Key (from the .p8 file downloaded from Apple Developer Portal)
# Can be provided as the full PEM content or as a file path
# Option 1: Paste the entire .p8 file content (including -----BEGIN PRIVATE KEY-----)
# APPLE_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----\nMIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEH...\n-----END PRIVATE KEY-----

# Option 2: Or provide the path to the .p8 file
# APPLE_PRIVATE_KEY_PATH=/path/to/AuthKey_XYZ9876WVU.p8

# OAuth Redirect URI (must match Apple Services ID configuration)
# APPLE_REDIRECT_URI=https://api.traf3li.com/api/auth/sso/apple/callback

# ==========================================
# TEMPORAL.IO WORKFLOW ENGINE (OPTIONAL)
# ==========================================
# Temporal is a durable workflow execution platform for complex business processes.
# Used for orchestrating long-running workflows like:
# - Invoice approval workflows
# - Employee onboarding/offboarding
# - Case lifecycle management
# - Multi-step document processing
# - Scheduled tasks and cron jobs
#
# SETUP (Local Development):
#   1. Start Temporal server with Docker:
#      docker-compose -f docker-compose.temporal.yml up -d
#   2. Access Temporal UI: http://localhost:8088
#   3. The application will auto-connect to localhost:7233
#
# SETUP (Production):
#   - Temporal Cloud: https://temporal.io/cloud (recommended)
#   - Self-hosted: https://docs.temporal.io/self-hosted
#
# NOTE: If not enabled, workflow features will be disabled

# Temporal server address
# Format: [host]:[port]
# Examples:
#   Local: localhost:7233
#   Docker: temporal:7233
#   Cloud: namespace.account.tmprl.cloud:7233
TEMPORAL_ADDRESS=localhost:7233

# Temporal namespace
# Default namespace is "default" for local development
# For Temporal Cloud, use your namespace ID
TEMPORAL_NAMESPACE=default

# Enable Temporal worker processes
# Set to "true" to start workflow workers with the application
# Set to "false" to disable Temporal integration
TEMPORAL_WORKER_ENABLED=true

# Temporal Cloud configuration (only needed for Temporal Cloud)
# TEMPORAL_CLOUD_NAMESPACE=your-namespace.account-id
# TEMPORAL_CLOUD_API_KEY=your-api-key
# TEMPORAL_CLOUD_API_SECRET=your-api-secret

# Department contact emails (used in workflow notifications)
# These emails receive notifications during workflow execution
IT_EMAIL=it@company.com
HR_EMAIL=hr@company.com
FINANCE_EMAIL=finance@company.com

# Workflow timeout configurations (optional, defaults are set in code)
# TEMPORAL_DEFAULT_TIMEOUT=86400000
# TEMPORAL_INVOICE_APPROVAL_TIMEOUT=604800000
# TEMPORAL_ONBOARDING_TIMEOUT=2592000000
# TEMPORAL_OFFBOARDING_TIMEOUT=1209600000

# ==========================================
# QUICKBOOKS ONLINE INTEGRATION
# ==========================================
# QuickBooks Online API for accounting sync
# Get credentials from: https://developer.intuit.com/app/developer/qbo/docs/get-started
#
# Required Scopes: com.intuit.quickbooks.accounting
# Callback URL: {BACKEND_URL}/api/integrations/quickbooks/callback

# OAuth Application Credentials
# QUICKBOOKS_CLIENT_ID=your_client_id_here
# QUICKBOOKS_CLIENT_SECRET=your_client_secret_here

# OAuth Redirect URI (must match Intuit developer portal)
# QUICKBOOKS_REDIRECT_URI=https://api.traf3li.com/api/integrations/quickbooks/callback

# QuickBooks environment (sandbox or production)
# QUICKBOOKS_ENVIRONMENT=sandbox

# ==========================================
# XERO INTEGRATION
# ==========================================
# Xero API for accounting sync
# Get credentials from: https://developer.xero.com/app/manage
#
# Required Scopes: openid profile email accounting.transactions accounting.contacts
# Callback URL: {BACKEND_URL}/api/integrations/xero/callback

# OAuth Application Credentials
# XERO_CLIENT_ID=your_client_id_here
# XERO_CLIENT_SECRET=your_client_secret_here

# OAuth Redirect URI (must match Xero developer portal)
# XERO_REDIRECT_URI=https://api.traf3li.com/api/integrations/xero/callback

# ==========================================
# FACEBOOK OAUTH LOGIN
# ==========================================
# Facebook OAuth for social login
# Get credentials from: https://developers.facebook.com/apps
#
# Required Scopes: email, public_profile
# Callback URL: {BACKEND_URL}/api/auth/sso/facebook/callback

# OAuth Application Credentials
# FACEBOOK_CLIENT_ID=your_facebook_app_id_here
# FACEBOOK_CLIENT_SECRET=your_facebook_app_secret_here

# OAuth Redirect URI
# FACEBOOK_REDIRECT_URI=https://api.traf3li.com/api/auth/sso/facebook/callback

# ==========================================
# GOOGLE CALENDAR INTEGRATION
# ==========================================
# Google Calendar API for calendar sync
# Get credentials from: https://console.cloud.google.com/apis/credentials
#
# Required APIs: Google Calendar API
# Required Scopes: https://www.googleapis.com/auth/calendar
# Callback URL: {BACKEND_URL}/api/google-calendar/callback

# OAuth Application Credentials
# GOOGLE_CALENDAR_CLIENT_ID=your_client_id_here
# GOOGLE_CALENDAR_CLIENT_SECRET=your_client_secret_here

# OAuth Redirect URI
# GOOGLE_CALENDAR_REDIRECT_URI=https://api.traf3li.com/api/google-calendar/callback

# ==========================================
# GOOGLE DRIVE INTEGRATION
# ==========================================
# Google Drive API for cloud document storage
# Get credentials from: https://console.cloud.google.com/apis/credentials
#
# Required APIs: Google Drive API
# Required Scopes: https://www.googleapis.com/auth/drive.file
# Callback URL: {BACKEND_URL}/api/storage/google-drive/callback

# OAuth Application Credentials
# GOOGLE_DRIVE_CLIENT_ID=your_client_id_here
# GOOGLE_DRIVE_CLIENT_SECRET=your_client_secret_here

# OAuth Redirect URI
# GOOGLE_DRIVE_REDIRECT_URI=https://api.traf3li.com/api/storage/google-drive/callback

# ==========================================
# DROPBOX INTEGRATION
# ==========================================
# Dropbox API for cloud document storage
# Get credentials from: https://www.dropbox.com/developers/apps
#
# Required Scopes: files.content.read, files.content.write
# Callback URL: {BACKEND_URL}/api/storage/dropbox/callback

# App Credentials
# DROPBOX_APP_KEY=your_app_key_here
# DROPBOX_APP_SECRET=your_app_secret_here

# OAuth Redirect URI
# DROPBOX_REDIRECT_URI=https://api.traf3li.com/api/storage/dropbox/callback

# ==========================================
# MICROSOFT ONEDRIVE INTEGRATION
# ==========================================
# OneDrive API for cloud document storage
# Get credentials from: https://portal.azure.com
# App Registration -> New Registration -> API Permissions -> Microsoft Graph
#
# Required Scopes: Files.ReadWrite.All, offline_access
# Callback URL: {BACKEND_URL}/api/storage/onedrive/callback

# OAuth Application Credentials
# ONEDRIVE_CLIENT_ID=your_client_id_here
# ONEDRIVE_CLIENT_SECRET=your_client_secret_here

# OAuth Redirect URI
# ONEDRIVE_REDIRECT_URI=https://api.traf3li.com/api/storage/onedrive/callback

# ==========================================
# SLACK INTEGRATION
# ==========================================
# Slack API for team communication
# Get credentials from: https://api.slack.com/apps
#
# Required Scopes: chat:write, channels:read, users:read, files:write
# OAuth Redirect URL: {BACKEND_URL}/api/slack/callback

# OAuth Application Credentials
# SLACK_CLIENT_ID=your_client_id_here
# SLACK_CLIENT_SECRET=your_client_secret_here
# SLACK_SIGNING_SECRET=your_signing_secret_here

# OAuth Redirect URI
# SLACK_REDIRECT_URI=https://api.traf3li.com/api/slack/callback

# ==========================================
# DISCORD INTEGRATION
# ==========================================
# Discord API for team communication
# Get credentials from: https://discord.com/developers/applications
#
# Required Scopes: bot, applications.commands
# Bot Permissions: Send Messages, Embed Links, Read Message History
# OAuth Redirect URL: {BACKEND_URL}/api/discord/callback

# OAuth Application Credentials
# DISCORD_CLIENT_ID=your_client_id_here
# DISCORD_CLIENT_SECRET=your_client_secret_here
# DISCORD_BOT_TOKEN=your_bot_token_here

# OAuth Redirect URI
# DISCORD_REDIRECT_URI=https://api.traf3li.com/api/discord/callback

# ==========================================
# TELEGRAM INTEGRATION
# ==========================================
# Telegram Bot API for notifications
# Create bot via: https://t.me/BotFather (send /newbot command)
#
# Webhook URL: {BACKEND_URL}/api/telegram/webhook

# Bot Token (from BotFather)
# TELEGRAM_BOT_TOKEN=your_bot_token_here

# Webhook URL (must be HTTPS)
# TELEGRAM_WEBHOOK_URL=https://api.traf3li.com/api/telegram/webhook

# ==========================================
# ZOOM INTEGRATION
# ==========================================
# Zoom API for video meetings
# Get credentials from: https://marketplace.zoom.us/develop/create
#
# App Type: OAuth
# Required Scopes: meeting:write:admin, meeting:read:admin, user:read:admin
# OAuth Redirect URL: {BACKEND_URL}/api/zoom/callback

# OAuth Application Credentials
# ZOOM_CLIENT_ID=your_client_id_here
# ZOOM_CLIENT_SECRET=your_client_secret_here

# OAuth Redirect URI
# ZOOM_REDIRECT_URI=https://api.traf3li.com/api/zoom/callback

# ==========================================
# GOOGLE OAUTH SSO LOGIN
# ==========================================
# Google OAuth 2.0 for social login and authentication
# Get credentials from: https://console.cloud.google.com/apis/credentials
#
# App Type: Web Application
# Required Scopes: openid, email, profile
# OAuth Redirect URL: {BACKEND_URL}/api/auth/sso/google/callback
# IMPORTANT: Enable "Google+ API" and "Google People API" in the Google Console

# OAuth Application Credentials
# GOOGLE_SSO_CLIENT_ID=your_client_id_here.apps.googleusercontent.com
# GOOGLE_SSO_CLIENT_SECRET=your_client_secret_here

# OAuth Redirect URI (must match Google Cloud Console configuration)
# GOOGLE_SSO_REDIRECT_URI=https://api.traf3li.com/api/auth/sso/google/callback

# ==========================================
# GITHUB OAUTH SSO LOGIN
# ==========================================
# GitHub OAuth 2.0 for social login and authentication
# Get credentials from: https://github.com/settings/developers
#
# App Type: OAuth App
# Required Scopes: read:user, user:email
# OAuth Redirect URL: {BACKEND_URL}/api/auth/sso/github/callback
# IMPORTANT: GitHub requires Accept: application/json header for token response

# OAuth Application Credentials
# GITHUB_SSO_CLIENT_ID=your_client_id_here
# GITHUB_SSO_CLIENT_SECRET=your_client_secret_here

# OAuth Redirect URI (must match GitHub OAuth App configuration)
# GITHUB_SSO_REDIRECT_URI=https://api.traf3li.com/api/auth/sso/github/callback

# ==========================================
# GITHUB INTEGRATION
# ==========================================
# GitHub API for code repository integration
# Get credentials from: https://github.com/settings/developers
#
# App Type: OAuth App
# Required Scopes: repo, read:user, user:email
# OAuth Redirect URL: {BACKEND_URL}/api/github/callback

# OAuth Application Credentials
# GITHUB_CLIENT_ID=your_client_id_here
# GITHUB_CLIENT_SECRET=your_client_secret_here

# OAuth Redirect URI
# GITHUB_REDIRECT_URI=https://api.traf3li.com/api/github/callback

# Webhook Secret (for repository webhooks)
# GITHUB_WEBHOOK_SECRET=your_webhook_secret_here

# ==========================================
# TRELLO INTEGRATION
# ==========================================
# Trello API for project management (OAuth 1.0a)
# Get credentials from: https://trello.com/power-ups/admin
#
# Required Scopes: read, write, account
# OAuth Redirect URL: {BACKEND_URL}/api/trello/callback

# API Key and Secret
# TRELLO_API_KEY=your_api_key_here
# TRELLO_API_SECRET=your_api_secret_here

# OAuth Redirect URI
# TRELLO_REDIRECT_URI=https://api.traf3li.com/api/trello/callback

# ==========================================
# GMAIL INTEGRATION
# ==========================================
# Gmail API for email integration
# Get credentials from: https://console.cloud.google.com/apis/credentials
#
# Required APIs: Gmail API
# Required Scopes: https://www.googleapis.com/auth/gmail.readonly,
#                  https://www.googleapis.com/auth/gmail.send,
#                  https://www.googleapis.com/auth/gmail.modify
# OAuth Redirect URL: {BACKEND_URL}/api/gmail/callback

# OAuth Application Credentials (can reuse Google Calendar credentials)
# GMAIL_CLIENT_ID=your_client_id_here
# GMAIL_CLIENT_SECRET=your_client_secret_here

# OAuth Redirect URI
# GMAIL_REDIRECT_URI=https://api.traf3li.com/api/gmail/callback

# Pub/Sub Topic for Gmail push notifications (optional)
# GMAIL_PUBSUB_TOPIC=projects/your-project/topics/gmail-notifications

# ==========================================
# DOCUSIGN INTEGRATION
# ==========================================
# DocuSign eSignature API for electronic signatures
# Get credentials from: https://developers.docusign.com
#
# Environment: Use developer account for sandbox, production for live
# Required Scopes: signature, impersonation
# OAuth Redirect URL: {BACKEND_URL}/api/docusign/callback

# OAuth Application Credentials
# DOCUSIGN_INTEGRATION_KEY=your_integration_key_here
# DOCUSIGN_SECRET_KEY=your_secret_key_here

# DocuSign Account/User IDs
# DOCUSIGN_ACCOUNT_ID=your_account_id_here

# OAuth Redirect URI
# DOCUSIGN_REDIRECT_URI=https://api.traf3li.com/api/docusign/callback

# Environment (developer or production)
# DOCUSIGN_ENVIRONMENT=developer

# Base URL (changes based on environment)
# Developer: https://demo.docusign.net/restapi
# Production: https://www.docusign.net/restapi
# DOCUSIGN_BASE_URL=https://demo.docusign.net/restapi

# Webhook Secret for DocuSign Connect (HMAC signature validation)
# Configure this secret in DocuSign Connect > Edit Configuration > Security > HMAC Secret
# Used to validate webhook signatures via x-docusign-signature-1 header
# DOCUSIGN_WEBHOOK_SECRET=your_webhook_secret_here

# ==========================================
# TWITTER/X OAUTH 2.0 INTEGRATION
# ==========================================
# Twitter OAuth 2.0 for social login and authentication
# Get credentials from: https://developer.twitter.com/en/portal/dashboard
#
# App Type: OAuth 2.0
# Required Scopes: tweet.read, users.read, offline.access
# OAuth Redirect URL: {BACKEND_URL}/api/auth/sso/twitter/callback
# IMPORTANT: Twitter requires PKCE (Proof Key for Code Exchange)

# OAuth Application Credentials
# TWITTER_CLIENT_ID=your_client_id_here
# TWITTER_CLIENT_SECRET=your_client_secret_here

# OAuth Redirect URI (must match Twitter developer portal)
# TWITTER_REDIRECT_URI=https://api.traf3li.com/api/auth/sso/twitter/callback

# ==========================================
# LINKEDIN OAUTH 2.0 INTEGRATION
# ==========================================
# LinkedIn OAuth 2.0 for social login and authentication
# Get credentials from: https://www.linkedin.com/developers/apps
#
# App Type: OAuth 2.0
# Required Scopes: openid, profile, email
# OAuth Redirect URL: {BACKEND_URL}/api/auth/sso/linkedin/callback

# OAuth Application Credentials
# LINKEDIN_CLIENT_ID=your_client_id_here
# LINKEDIN_CLIENT_SECRET=your_client_secret_here

# OAuth Redirect URI (must match LinkedIn developer portal)
# LINKEDIN_REDIRECT_URI=https://api.traf3li.com/api/auth/sso/linkedin/callback
