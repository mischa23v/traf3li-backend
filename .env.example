# ==========================================
# TRAF3LI BACKEND ENVIRONMENT CONFIGURATION
# ==========================================
#
# ðŸš€ QUICK START GUIDE:
#   1. Copy this file: cp .env.example .env
#   2. Generate secrets (run each command 3 times, copy output):
#      node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
#   3. Paste the 3 generated values into JWT_SECRET, JWT_REFRESH_SECRET, and ENCRYPTION_KEY
#   4. Set MONGODB_URI to your MongoDB connection string
#   5. Configure optional services (Redis, Sentry, AWS S3, etc.) as needed
#   6. Start server: npm start
#
# âš ï¸  SECURITY WARNING:
#   - Never commit .env file to git (it's in .gitignore)
#   - Never share your secrets in Slack, email, or other channels
#   - Never reuse secrets across environments (dev, staging, production)
#   - Generate new secrets for each environment
#
# ==========================================
# CRITICAL SECURITY CONFIGURATION (REQUIRED)
# ==========================================
# These values MUST be set before starting the server.
# The application will fail to start if these are missing or invalid.

# JWT Secrets - Used for authentication tokens
# REQUIREMENTS:
#   - JWT_SECRET: Minimum 32 characters, used for access tokens (15 min expiry)
#   - JWT_REFRESH_SECRET: Minimum 32 characters, used for refresh tokens (7 day expiry)
#   - Must be different from each other
#   - Use cryptographically secure random values
#
# GENERATE NEW SECRETS (run these commands):
#   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
#   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
#
# Copy the output and paste below (one secret per line):
JWT_SECRET=your_secret_here
JWT_REFRESH_SECRET=your_secret_here

# Encryption Key - Used for encrypting sensitive data at rest
# REQUIREMENTS:
#   - Must be exactly 64 hexadecimal characters (32 bytes)
#   - Used for AES-256-GCM encryption of sensitive legal/financial data
#   - Never change this after encrypting data (you won't be able to decrypt)
#
# GENERATE NEW KEY (run this command):
#   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
#
# Copy the output and paste below:
ENCRYPTION_KEY=your_key_here

# DO NOT CHANGE - Encryption algorithm (AES-256-GCM is the standard)
ENCRYPTION_ALGORITHM=aes-256-gcm

# Database Connection
# REQUIREMENTS:
#   - Must be a valid MongoDB connection string
#   - Format: mongodb://[user]:[password]@[host]:[port]/[database]
#   - For MongoDB Atlas: mongodb+srv://[user]:[password]@[cluster]/[database]
#   - Production: Should use SSL/TLS (?ssl=true or ?tls=true)
#
# EXAMPLE:
#   Local: mongodb://localhost:27017/traf3li
#   Atlas: mongodb+srv://user:password@cluster.mongodb.net/traf3li?retryWrites=true&w=majority
MONGODB_URI=your_mongodb_uri

# Server
PORT=5000
NODE_ENV=production

# Security
ADMIN_IP_WHITELIST=your.ip.here

# Frontend URLs
CLIENT_URL=https://traf3li.com
DASHBOARD_URL=https://dashboard.traf3li.com

# Backend URL (for SAML/SSO metadata and callbacks)
BACKEND_URL=https://api.traf3li.com

# Stripe
STRIPE_SECRET_KEY=your_stripe_key

# Cloudinary
CLOUDINARY_CLOUD_NAME=your_name
CLOUDINARY_API_KEY=your_key
CLOUDINARY_API_SECRET=your_secret

# AWS S3 (for file storage)
AWS_ACCESS_KEY_ID=your_access_key_id
AWS_SECRET_ACCESS_KEY=your_secret_access_key
AWS_REGION=me-south-1

# S3 Buckets - Use either naming convention:
# Option 1 (recommended): S3_BUCKET_* prefix
S3_BUCKET_DOCUMENTS=traf3li-legal-documents
S3_BUCKET_JUDGMENTS=traf3li-case-judgments
S3_BUCKET_TASKS=traf3li-task-attachments

# Option 2 (alternative): AWS_S3_* prefix
# AWS_S3_BUCKET=traf3li-legal-documents
# AWS_S3_BUCKET_DOCUMENTS=traf3li-legal-documents
# AWS_S3_JUDGMENTS_BUCKET=traf3li-case-judgments

# S3 Logging Buckets (optional - for access tracking)
# Enable versioning on main buckets for version history support
S3_BUCKET_DOCUMENTS_LOGS=traf3li-documents-logs
S3_BUCKET_TASKS_LOGS=traf3li-tasks-logs
# Alternative naming:
# AWS_S3_BUCKET_DOCUMENTS_LOGS=traf3li-documents-logs
# AWS_S3_BUCKET_TASKS_LOGS=traf3li-tasks-logs

# S3 Server-Side Encryption (SSE)
# SSE is enabled by default using AES256 (SSE-S3)
S3_SSE_ENABLED=true
S3_SSE_ALGORITHM=AES256
# For SSE-KMS encryption with Bucket Key (reduces KMS costs):
# S3_SSE_ALGORITHM=aws:kms
# S3_KMS_KEY_ID=arn:aws:kms:region:account:key/key-id
# S3_BUCKET_KEY_ENABLED=true

# Presigned URL expiry time in seconds (default: 3600 = 1 hour)
PRESIGNED_URL_EXPIRY=3600

# ==========================================
# REDIS CONFIGURATION (RECOMMENDED)
# ==========================================
# Redis is used for caching, rate limiting, session storage, and job queues.
# While not strictly required, it's highly recommended for production.
#
# SETUP (Local Development):
#   1. Install Redis: brew install redis (macOS) or apt-get install redis (Linux)
#   2. Start Redis: redis-server
#   3. Use: redis://localhost:6379
#
# SETUP (Production):
#   - Upstash (Free tier): https://upstash.com
#   - Redis Labs: https://redis.com
#   - AWS ElastiCache: https://aws.amazon.com/elasticache/
#
# NOTE: If not set, the application will use in-memory fallbacks (not shared across instances)

# Redis connection URL
# Format: redis://[username]:[password]@[host]:[port]/[database]
# Examples:
#   Local: redis://localhost:6379
#   Docker: redis://redis:6379
#   Upstash: redis://default:[password]@[endpoint].upstash.io:6379
#   Cloud: redis://:password@redis.example.com:6379
REDIS_URL=redis://localhost:6379

# Redis password (leave empty for local development without auth)
REDIS_PASSWORD=

# âš ï¸  REDIS OPTIMIZATION FOR FREE TIER (Upstash 500k requests/month)
# Set these to reduce Redis usage if you're hitting limits:

# Disable Bull job queues entirely (email, PDF, reports run synchronously)
# Set to "true" to save ~70k requests/month from queue polling
DISABLE_QUEUES=false

# Disable Redis caching, use in-memory cache instead
# Set to "true" to eliminate cache-related Redis calls
# Note: In-memory cache is per-process, not shared across instances
DISABLE_REDIS_CACHE=false

# Redis use cases in this application:
# - Idempotency keys for preventing duplicate transactions
# - Response caching for high-traffic endpoints (dashboard, clients, cases)
# - Session storage
# - Rate limiting counters
# - Job queues (email, PDF, reports, cleanup, sync, notifications)

# ==========================================
# ACCOUNTING SYSTEM CONFIGURATION
# ==========================================

# Currency Settings
DEFAULT_CURRENCY=SAR

# Default Account IDs (set after running seed:accounts)
# These are populated by the seeder, but can be overridden
# ACCOUNTS_RECEIVABLE_ID=
# ACCOUNTS_PAYABLE_ID=
# SERVICE_REVENUE_ID=
# BANK_ACCOUNT_MAIN_ID=

# Accounting Features
ENABLE_ACCOUNTING=true
REQUIRE_IDEMPOTENCY_KEYS=true

# External Integrations (optional)
# Twilio for SMS notifications
# TWILIO_ACCOUNT_SID=
# TWILIO_AUTH_TOKEN=
# TWILIO_PHONE_NUMBER=

# ==========================================
# LOGGING CONFIGURATION
# ==========================================

# Log level: error, warn, info, debug
LOG_LEVEL=info

# ==========================================
# ANALYTICS CONFIGURATION
# ==========================================

# Analytics event tracking (matches frontend taxonomy)
# Events tracked: page_view, search, form_submit, error, api_call, user_action
# Set to false to disable analytics tracking
ENABLE_ANALYTICS=true

# Analytics buffer settings
# Events are batched and flushed periodically to reduce overhead
ANALYTICS_BUFFER_FLUSH_INTERVAL=30000
ANALYTICS_MAX_BUFFER_SIZE=100

# External analytics integrations (optional)
# Google Analytics Measurement Protocol
# GA_MEASUREMENT_ID=G-XXXXXXXXXX
# GA_API_SECRET=your_api_secret

# Mixpanel
# MIXPANEL_TOKEN=your_mixpanel_token

# Segment
# SEGMENT_WRITE_KEY=your_segment_write_key

# ==========================================
# PERFORMANCE MONITORING
# ==========================================

# API response time target (in ms)
# Frontend expects backend APIs to respond within this threshold
API_RESPONSE_TIME_TARGET=300

# Performance thresholds (in ms)
# PERF_THRESHOLD_EXCELLENT=100
# PERF_THRESHOLD_GOOD=300
# PERF_THRESHOLD_ACCEPTABLE=1000
# PERF_THRESHOLD_SLOW=3000

# Performance monitoring endpoints
# GET /metrics/performance - Detailed API performance metrics
# Includes: avg response time, percentiles (p50, p90, p99), slowest endpoints

# ==========================================
# SENTRY ERROR TRACKING (RECOMMENDED)
# ==========================================
# Sentry provides real-time error tracking and performance monitoring.
# While not required, it's highly recommended for production environments.
#
# SETUP:
#   1. Create account at https://sentry.io
#   2. Create a new Node.js project
#   3. Copy the DSN from Project Settings > Client Keys (DSN)
#   4. Paste it below
#
# NOTE: If not set, error tracking will be disabled (not recommended for production)

# Sentry DSN (Data Source Name) - Get this from your Sentry project settings
# Format: https://[key]@[organization].ingest.sentry.io/[project-id]
SENTRY_DSN=https://your-sentry-dsn@sentry.io/your-project-id

# Sentry environment (production, staging, development)
SENTRY_ENVIRONMENT=production

# Sentry traces sample rate (0.0 to 1.0, where 1.0 = 100%)
# Lower values reduce performance monitoring overhead
SENTRY_TRACES_SAMPLE_RATE=0.1

# Sentry profiles sample rate (0.0 to 1.0, where 1.0 = 100%)
# Only needed if using profiling
SENTRY_PROFILES_SAMPLE_RATE=0.1

# ==========================================
# WHATSAPP / META CONFIGURATION
# ==========================================

# Meta WhatsApp Business API
# WHATSAPP_PHONE_NUMBER_ID=
# WHATSAPP_ACCESS_TOKEN=
# WHATSAPP_VERIFY_TOKEN=
# WHATSAPP_BUSINESS_ACCOUNT_ID=

# ==========================================
# EMAIL CONFIGURATION
# ==========================================

# Resend API for email sending
RESEND_API_KEY=your_resend_api_key

# Email sender configuration
EMAIL_FROM=noreply@traf3li.com
EMAIL_FROM_NAME=Traf3li
EMAIL_REPLY_TO=support@traf3li.com

# Email branding
LOGO_URL=https://traf3li.com/logo.png

# Email templates support both Arabic and English
# Templates include: welcome, otp, invoice, payment-receipt, case-update, reminder, password-reset
# Layouts: base (full featured), notification (simple), transactional (invoices/receipts)

# ==========================================
# SAUDI BANKING INTEGRATION
# ==========================================

# Lean Technologies (Open Banking)
# LEAN_APP_TOKEN=
# LEAN_CUSTOMER_ID=

# SADAD Integration
# SADAD_MERCHANT_ID=
# SADAD_API_KEY=

# ZATCA (VAT Invoicing)
# ZATCA_API_KEY=
# ZATCA_ORGANIZATION_ID=

# ==========================================
# BACKUP CONFIGURATION
# ==========================================

# S3 Backup Bucket
BACKUP_S3_BUCKET=traf3li-backups

# Retention Policies (in days/weeks/months)
BACKUP_RETENTION_DAYS=7
BACKUP_RETENTION_WEEKS=4
BACKUP_RETENTION_MONTHS=12
BACKUP_RETENTION_YEARS=3

# Backup Schedules (cron expressions)
# Daily at 2 AM
BACKUP_SCHEDULE_DAILY=0 2 * * *
# Weekly on Sunday at 3 AM
BACKUP_SCHEDULE_WEEKLY=0 3 * * 0
# Monthly on the 1st at 4 AM
BACKUP_SCHEDULE_MONTHLY=0 4 1 * *
# Redis every 6 hours
BACKUP_SCHEDULE_REDIS=0 */6 * * *

# Notification Settings
BACKUP_NOTIFICATION_ENABLED=true
BACKUP_NOTIFICATION_EMAIL=admin@traf3li.com
BACKUP_NOTIFY_ON_SUCCESS=false

# Backup Settings
BACKUP_TEMP_DIR=/tmp/backups
BACKUP_MAX_FILE_SIZE=524288000
BACKUP_COMPRESSION_LEVEL=6

# Point-in-Time Recovery (PITR)
BACKUP_ENABLE_PITR=false
BACKUP_PITR_INTERVAL=15

# Redis Settings (if different from main Redis)
REDIS_DATA_DIR=/data

# Restore Settings
RESTORE_TEMP_DIR=/tmp/restore
RESTORE_BACKUP_BEFORE=true

# ==========================================
# MALWARE SCANNING (ClamAV)
# ==========================================

# Enable malware scanning for file uploads
# Set to "true" to enable ClamAV scanning, "false" to disable
ENABLE_MALWARE_SCAN=true

# ClamAV daemon connection settings
# For Docker: use service name (e.g., "clamav")
# For local: use "localhost"
CLAMAV_HOST=localhost

# ClamAV daemon TCP port
# Default ClamAV TCP socket port is 3310
CLAMAV_PORT=3310

# Malware scanning behavior:
# - Development: Scan if available, allow upload if scan fails (with warning)
# - Production: Scan required, block upload if scan fails
# Note: Infected files are ALWAYS blocked in both environments

# ==========================================
# SAML/SSO CONFIGURATION (Enterprise)
# ==========================================

# SAML is configured per firm through the admin dashboard
# Each firm can have its own IdP configuration (Azure AD, Okta, Google Workspace, etc.)

# SAML endpoints are automatically generated using BACKEND_URL:
# - SP Entity ID: {BACKEND_URL}/api/auth/saml/{firmId}
# - ACS URL: {BACKEND_URL}/api/auth/saml/acs/{firmId}
# - SLS URL: {BACKEND_URL}/api/auth/saml/sls/{firmId}
# - Metadata URL: {BACKEND_URL}/api/auth/saml/metadata/{firmId}

# Configuration is done through the dashboard:
# Dashboard -> Settings -> Enterprise -> SSO Configuration

# Required information from IdP:
# - Provider Type (azure, okta, google, custom)
# - Entity ID / Issuer URL
# - SSO URL / Sign-in URL
# - X.509 Certificate (PEM format)
# - Metadata URL (optional)

# Supported Providers:
# - Microsoft Azure AD (Entra ID)
# - Okta
# - Google Workspace
# - Any SAML 2.0 compliant IdP

# Features:
# - Just-in-Time (JIT) user provisioning
# - Attribute mapping (email, firstName, lastName, groups)
# - Single Logout (SLO) support
# - Multi-tenancy (firm-level isolation)
# - Automatic JWT token generation after SSO
