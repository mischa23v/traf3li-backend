/**
 * Malware Scan Middleware
 *
 * Intercepts file uploads after multer and scans them for malware using ClamAV.
 * Integrates with the malware scanning service to provide security scanning.
 *
 * Usage:
 * - Apply after multer middleware
 * - Scans req.file or req.files
 * - Rejects infected files with 400 response
 * - Logs all security events
 *
 * Example:
 *   router.post('/upload',
 *     upload.single('file'),
 *     malwareScanMiddleware,
 *     controller.handleUpload
 *   );
 */

const malwareScanService = require('../services/malwareScan.service');
const fs = require('fs').promises;
const path = require('path');
const logger = require('../utils/logger');

/**
 * Scan uploaded file(s) for malware
 * @param {Object} req - Express request
 * @param {Object} res - Express response
 * @param {Function} next - Express next function
 */
const malwareScanMiddleware = async (req, res, next) => {
  try {
    // Check if malware scanning is disabled (enabled by default)
    if (process.env.ENABLE_MALWARE_SCAN === 'false') {
      // Skip scanning if explicitly disabled
      return next();
    }

    // Initialize scanner if not already done
    if (!malwareScanService.isInitialized) {
      await malwareScanService.initialize();
    }

    // Build context for logging
    const context = {
      userId: req.userID || req.user?._id,
      userEmail: req.user?.email,
      ipAddress: req.ip || req.connection?.remoteAddress,
      userAgent: req.get('user-agent'),
      endpoint: req.originalUrl,
      method: req.method,
    };

    // Handle single file upload (req.file)
    if (req.file) {
      const scanResult = await scanSingleFile(req.file, context);

      if (!scanResult.clean) {
        // Delete the infected file
        await deleteFile(req.file.path);

        // Return error response
        return res.status(400).json({
          success: false,
          error: true,
          message: scanResult.blocked
            ? 'ملف مرفوض: فشل التحقق من سلامة الملف'
            : 'ملف مرفوض: تم اكتشاف محتوى ضار',
          code: 'MALWARE_DETECTED',
          details: {
            fileName: req.file.originalname,
            virus: scanResult.virus || 'Unknown threat',
            blocked: scanResult.blocked || false,
          }
        });
      }

      // Attach scan result to request for later use
      req.malwareScan = scanResult;
    }

    // Handle multiple file uploads (req.files)
    if (req.files) {
      const files = Array.isArray(req.files) ? req.files : Object.values(req.files).flat();

      for (const file of files) {
        const scanResult = await scanSingleFile(file, context);

        if (!scanResult.clean) {
          // Delete all uploaded files if any is infected
          await deleteAllFiles(files);

          // Return error response
          return res.status(400).json({
            success: false,
            error: true,
            message: scanResult.blocked
              ? 'ملفات مرفوضة: فشل التحقق من سلامة الملفات'
              : 'ملفات مرفوضة: تم اكتشاف محتوى ضار في أحد الملفات',
            code: 'MALWARE_DETECTED',
            details: {
              fileName: file.originalname,
              virus: scanResult.virus || 'Unknown threat',
              blocked: scanResult.blocked || false,
            }
          });
        }
      }

      // Attach scan results to request
      req.malwareScan = { clean: true, filesScanned: files.length };
    }

    // No files uploaded or all files clean - proceed
    next();
  } catch (error) {
    logger.error('Malware scan middleware error:', error);

    // In production, block uploads if scanning fails
    if (process.env.NODE_ENV === 'production') {
      // Delete uploaded files
      if (req.file) {
        await deleteFile(req.file.path).catch(() => {});
      }
      if (req.files) {
        const files = Array.isArray(req.files) ? req.files : Object.values(req.files).flat();
        await deleteAllFiles(files).catch(() => {});
      }

      return res.status(500).json({
        success: false,
        error: true,
        message: 'فشل التحقق من سلامة الملف. يرجى المحاولة مرة أخرى.',
        code: 'SCAN_FAILED'
      });
    }

    // In development, log warning and proceed
    logger.warn('Malware scan failed in development, allowing upload');
    next();
  }
};

/**
 * Scan a single file
 * @private
 * @param {Object} file - Multer file object
 * @param {Object} context - Request context for logging
 * @returns {Promise<Object>} - Scan result
 */
async function scanSingleFile(file, context) {
  const fileContext = {
    ...context,
    fileName: file.originalname,
    fileSize: file.size,
    mimeType: file.mimetype,
  };

  // Use the file path if available (local storage)
  if (file.path) {
    return await malwareScanService.scanFile(file.path, fileContext);
  }

  // Use buffer if available (memory storage or cloud storage)
  if (file.buffer) {
    return await malwareScanService.scanBuffer(file.buffer, file.originalname, fileContext);
  }

  // No path or buffer available - skip scan
  logger.warn('File has no path or buffer, skipping malware scan:', file.originalname);
  return { clean: true, skipped: true, reason: 'No file data available' };
}

/**
 * Delete a single file safely
 * @private
 * @param {String} filePath - Path to file to delete
 * @returns {Promise<void>}
 */
async function deleteFile(filePath) {
  try {
    if (filePath) {
      await fs.unlink(filePath);
      logger.info(`Deleted infected file: ${path.basename(filePath)}`);
    }
  } catch (error) {
    logger.error(`Failed to delete file ${filePath}:`, error.message);
  }
}

/**
 * Delete multiple files safely
 * @private
 * @param {Array} files - Array of multer file objects
 * @returns {Promise<void>}
 */
async function deleteAllFiles(files) {
  const deletePromises = files
    .filter(file => file.path)
    .map(file => deleteFile(file.path));

  await Promise.allSettled(deletePromises);
}

/**
 * Scan middleware variant that only scans but doesn't block
 * Useful for logging/monitoring without rejecting uploads
 * @param {Object} req - Express request
 * @param {Object} res - Express response
 * @param {Function} next - Express next function
 */
const malwareScanMiddlewareMonitorOnly = async (req, res, next) => {
  try {
    // Check if malware scanning is disabled (enabled by default)
    if (process.env.ENABLE_MALWARE_SCAN === 'false') {
      return next();
    }

    // Initialize scanner if not already done
    if (!malwareScanService.isInitialized) {
      await malwareScanService.initialize();
    }

    // Build context for logging
    const context = {
      userId: req.userID || req.user?._id,
      userEmail: req.user?.email,
      ipAddress: req.ip || req.connection?.remoteAddress,
      userAgent: req.get('user-agent'),
      endpoint: req.originalUrl,
      method: req.method,
    };

    // Scan files but don't block
    if (req.file) {
      const scanResult = await scanSingleFile(req.file, context);
      req.malwareScan = scanResult;

      if (!scanResult.clean) {
        logger.warn(`MONITOR MODE: Malware detected but not blocking: ${req.file.originalname}`);
      }
    }

    if (req.files) {
      const files = Array.isArray(req.files) ? req.files : Object.values(req.files).flat();
      const scanResults = [];

      for (const file of files) {
        const scanResult = await scanSingleFile(file, context);
        scanResults.push(scanResult);

        if (!scanResult.clean) {
          logger.warn(`MONITOR MODE: Malware detected but not blocking: ${file.originalname}`);
        }
      }

      req.malwareScan = { results: scanResults, filesScanned: files.length };
    }

    // Always proceed (monitor only)
    next();
  } catch (error) {
    logger.error('Malware scan monitor error:', error);
    // Always proceed in monitor mode
    next();
  }
};

module.exports = malwareScanMiddleware;
module.exports.monitorOnly = malwareScanMiddlewareMonitorOnly;
