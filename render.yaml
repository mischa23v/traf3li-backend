# Render Deployment Configuration
# Documentation: https://render.com/docs/yaml-spec
# Total Cost: ~$14/month (Backend $7 + ClamAV $7)

services:
  # =============================================================
  # Main Backend API ($7/month - Starter plan)
  # =============================================================
  - type: web
    name: traf3li-backend
    env: node
    region: oregon # Choose: oregon, frankfurt, singapore
    plan: starter # $7/month for production

    # Build Configuration
    buildCommand: npm install
    startCommand: node --max-old-space-size=512 src/server.js

    # Health Check
    healthCheckPath: /health

    # Environment Variables
    envVars:
      - key: NODE_ENV
        value: production

      # ClamAV Malware Scanner (connects to internal clamav service)
      - key: CLAMAV_HOST
        fromService:
          name: clamav
          type: pserv
          property: host
      - key: CLAMAV_PORT
        value: 3310
      - key: MALWARE_SCAN_PROVIDER
        value: clamav

      # Database (set in Render dashboard - secret)
      - key: MONGODB_URI
        sync: false

      # JWT Secrets (set in Render dashboard - secret)
      - key: JWT_SECRET
        sync: false
      - key: JWT_REFRESH_SECRET
        sync: false
      - key: ENCRYPTION_KEY
        sync: false

      # Stripe (set in Render dashboard - secret)
      - key: STRIPE_SECRET_KEY
        sync: false

      # Cloudflare R2 Storage (set in Render dashboard - secret)
      - key: R2_ACCESS_KEY_ID
        sync: false
      - key: R2_SECRET_ACCESS_KEY
        sync: false
      - key: R2_ENDPOINT
        sync: false
      - key: R2_ACCOUNT_ID
        sync: false

      # R2 Bucket names (can be set here or in dashboard)
      - key: R2_BUCKET_CRM
        sync: false
      - key: R2_BUCKET_DOCUMENTS
        sync: false
      - key: R2_BUCKET_FINANCE
        sync: false
      - key: R2_BUCKET_HR
        sync: false
      - key: R2_BUCKET_JUDGMENTS
        sync: false

      # R2 Logging Buckets (optional - for access tracking)
      - key: R2_BUCKET_CRM_LOGS
        sync: false
      - key: R2_BUCKET_DOCUMENTS_LOGS
        sync: false
      - key: R2_BUCKET_FINANCE_LOGS
        sync: false
      - key: R2_BUCKET_HR_LOGS
        sync: false
      - key: R2_BUCKET_JUDGMENTS_LOGS
        sync: false

      # Frontend URLs for CORS (optional - already in code)
      - key: CLIENT_URL
        value: https://traf3li.com

      - key: DASHBOARD_URL
        value: https://dashboard.traf3li.com

      # Test mode (disable in production)
      - key: TEST_MODE
        value: false

    # Note: Security headers (X-Frame-Options, etc.) are set in Express middleware
    # Render's headers config is only for static sites, not Node.js services

    # Auto-Deploy
    autoDeploy: true

    # Scaling (Free tier: 1 instance only)
    numInstances: 1

    # Disk for uploads (optional)
    disk:
      name: uploads
      mountPath: /opt/render/project/src/uploads
      sizeGB: 1

  # =============================================================
  # ClamAV Antivirus Service ($7/month - Starter plan)
  # Internal service - not exposed to internet
  # =============================================================
  - type: pserv
    name: clamav
    env: docker
    region: oregon # Same region as backend for low latency
    plan: starter # $7/month
    dockerfilePath: ./docker/clamav/Dockerfile
    dockerContext: ./docker/clamav

    # Disk for virus definitions (~400MB, updates daily)
    disk:
      name: clamav-definitions
      mountPath: /var/lib/clamav
      sizeGB: 1

# =============================================================
# SETUP INSTRUCTIONS
# =============================================================
#
# 1. Push this file to your repo
# 2. In Render Dashboard, click "New" â†’ "Blueprint"
# 3. Connect your GitHub repo
# 4. Render will create both services automatically
# 5. Set secret environment variables in the Dashboard:
#    - MONGODB_URI
#    - JWT_SECRET
#    - JWT_REFRESH_SECRET
#    - ENCRYPTION_KEY
#    - R2_ACCESS_KEY_ID
#    - R2_SECRET_ACCESS_KEY
#    - R2_ENDPOINT
#
# ClamAV will automatically:
# - Download virus definitions on startup (~2-3 minutes first time)
# - Update definitions daily
# - Accept scan requests from backend on port 3310
#
# Total Monthly Cost: ~$14 (Backend $7 + ClamAV $7)
# =============================================================
