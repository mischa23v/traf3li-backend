# Docker Compose Configuration for ClamAV Malware Scanning
#
# This file provides a ClamAV service that can be integrated with your existing
# docker-compose setup for malware scanning capabilities.
#
# Usage:
#   1. Standalone: docker-compose -f docker-compose.clamav.yml up -d
#   2. With existing compose: docker-compose -f docker-compose.yml -f docker-compose.clamav.yml up -d
#   3. Merge into your main docker-compose.yml

version: '3.8'

services:
  # ClamAV Anti-Virus Daemon
  clamav:
    build:
      context: .
      dockerfile: Dockerfile.clamav
    container_name: traf3li-clamav

    # Expose ClamAV TCP socket port
    ports:
      - "3310:3310"

    # Environment variables for ClamAV configuration
    environment:
      # Don't skip freshclam - update virus definitions on startup
      - CLAMAV_NO_FRESHCLAM=false
      # Increase startup timeout for initial virus DB download (30 minutes)
      - CLAMD_STARTUP_TIMEOUT=1800

    # Health check to ensure daemon is running
    healthcheck:
      test: ["CMD", "clamdscan", "--ping"]
      interval: 60s
      timeout: 10s
      start_period: 300s  # Allow 5 minutes for initial virus DB download
      retries: 3

    # Restart policy
    restart: unless-stopped

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

    # Volume for persistent virus database
    volumes:
      - clamav_db:/var/lib/clamav
      - clamav_logs:/var/log/clamav

    # Network
    networks:
      - traf3li-network

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Example backend service configuration (modify to match your setup)
  # Uncomment and adjust if you want to see how to integrate with your backend
  # backend:
  #   build: .
  #   container_name: traf3li-backend
  #   ports:
  #     - "5000:5000"
  #   environment:
  #     # Enable malware scanning
  #     - ENABLE_MALWARE_SCAN=true
  #     # Use service name as hostname in Docker network
  #     - CLAMAV_HOST=clamav
  #     - CLAMAV_PORT=3310
  #     # Other backend env vars...
  #   depends_on:
  #     clamav:
  #       condition: service_healthy
  #   networks:
  #     - traf3li-network

# Volumes
volumes:
  clamav_db:
    driver: local
    name: traf3li-clamav-db
  clamav_logs:
    driver: local
    name: traf3li-clamav-logs

# Networks
networks:
  traf3li-network:
    driver: bridge
    name: traf3li-network
