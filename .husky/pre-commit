#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "${YELLOW}Running pre-commit security checks...${NC}"

# Check for hardcoded secrets
echo "Checking for hardcoded secrets..."

# List of secret patterns to check
PATTERNS=(
    "password\s*=\s*['\"][^'\"]{3,}['\"]"
    "api[_-]?key\s*=\s*['\"][^'\"]{10,}['\"]"
    "secret\s*=\s*['\"][^'\"]{10,}['\"]"
    "token\s*=\s*['\"][^'\"]{10,}['\"]"
    "aws[_-]?access[_-]?key[_-]?id\s*=\s*['\"]AKIA[0-9A-Z]{16}['\"]"
    "aws[_-]?secret[_-]?access[_-]?key\s*=\s*['\"][^'\"]{20,}['\"]"
    "private[_-]?key\s*=\s*['\"]"
    "-----BEGIN\s+(RSA\s+)?PRIVATE\s+KEY-----"
    "mongodb(\+srv)?://[^/]+:[^@]+@"
    "postgres(ql)?://[^/]+:[^@]+@"
    "mysql://[^/]+:[^@]+@"
    "Bearer\s+[A-Za-z0-9\-\._~\+\/]+=*"
    "['\"]sk_live_[0-9a-zA-Z]{24,}['\"]"
    "['\"]pk_live_[0-9a-zA-Z]{24,}['\"]"
)

# Get staged files (excluding certain paths)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -v -E "\.lock$|\.md$|package-lock\.json|\.husky/")

if [ -z "$STAGED_FILES" ]; then
    echo "${GREEN}✓ No files to check${NC}"
else
    SECRETS_FOUND=false

    for FILE in $STAGED_FILES; do
        # Skip binary files and non-existent files
        if [ ! -f "$FILE" ] || file "$FILE" | grep -q "binary"; then
            continue
        fi

        for PATTERN in "${PATTERNS[@]}"; do
            if grep -iE "$PATTERN" "$FILE" > /dev/null 2>&1; then
                if [ "$SECRETS_FOUND" = false ]; then
                    echo ""
                    echo "${RED}============================================${NC}"
                    echo "${RED}  ⚠️  POTENTIAL SECRETS DETECTED  ⚠️${NC}"
                    echo "${RED}============================================${NC}"
                    SECRETS_FOUND=true
                fi
                echo "${RED}✗ Potential secret found in: ${FILE}${NC}"
                grep -niE "$PATTERN" "$FILE" | head -3
                echo ""
            fi
        done
    done

    if [ "$SECRETS_FOUND" = true ]; then
        echo "${RED}============================================${NC}"
        echo "${RED}Commit blocked due to potential secrets!${NC}"
        echo "${YELLOW}If this is a false positive:${NC}"
        echo "${YELLOW}1. Review the flagged content${NC}"
        echo "${YELLOW}2. Move secrets to .env file${NC}"
        echo "${YELLOW}3. Use environment variables${NC}"
        echo "${YELLOW}4. To bypass (use with caution):${NC}"
        echo "${YELLOW}   git commit --no-verify${NC}"
        echo "${RED}============================================${NC}"
        exit 1
    fi
fi

echo "${GREEN}✓ No hardcoded secrets detected${NC}"

# Run lint-staged
echo "Running lint-staged..."
npx lint-staged

echo "${GREEN}✓ Pre-commit checks passed${NC}"
